<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POL Price Proxy - Operações Reais</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        button { background: #8247e5; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0; }
        button:disabled { background: #cccccc; }
        input, select { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .balance { font-weight: bold; }
        #networkWarning { color: red; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>POL Price Proxy - Operações Reais</h1>
        <p id="networkWarning">Por favor, conecte-se à Polygon Mainnet no MetaMask!</p>
        
        <!-- Seção Carteira -->
        <div class="section">
            <h2>1. Conexão da Carteira</h2>
            <button id="connectWallet">Conectar MetaMask</button>
            <div id="walletInfo" style="display: none;">
                <p>Conectado: <span id="walletAddress"></span></p>
                <div class="balance">Saldo MATIC: <span id="maticBalance"></span></div>
                <div class="balance">Saldo POL: <span id="polBalance"></span></div>
                <div class="balance">Saldo USDC: <span id="usdcBalance"></span></div>
            </div>
        </div>

        <!-- Restante do código permanece igual -->
        <!-- ... -->
    </div>

    <script>
        // Configurações
        const contractAddress = "0x6Cc8B4a08be3D8e0C7Ef0F4C9eF1cD336f6DDc4d";
        const polTokenAddress = "0x455e53CBB86018Ac2B8092FdCd39d8444aFFC3F6";
        const usdcTokenAddress = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174";
        const quickSwapRouter = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff";
        const polygonChainId = "0x89"; // Polygon Mainnet

        // ABIs (mantidas iguais)
        // ...

        // Variáveis globais
        let web3;
        let accounts;
        let contract;
        let polToken;
        let usdcToken;
        let priceOverrideEnabled = false;

        // Inicialização corrigida
        window.addEventListener('load', async () => {
            // Verifica se MetaMask está instalado
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                
                try {
                    // Solicita conexão da carteira
                    document.getElementById('connectWallet').addEventListener('click', async () => {
                        await connectWallet();
                    });
                    
                    // Verifica rede automaticamente
                    await checkNetwork();
                    
                } catch (error) {
                    console.error("Erro na inicialização:", error);
                }
            } else {
                alert("Por favor instale o MetaMask!");
            }
        });

        // Função corrigida para conectar carteira
        async function connectWallet() {
            try {
                // Solicita acesso à conta
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Verifica se está na Polygon
                await checkNetwork();
                
                // Inicializa contratos
                initContracts();
                
                // Atualiza UI
                await updateUI();
                
                // Mostra informações da carteira
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletAddress').textContent = accounts[0];
                
            } catch (error) {
                console.error("Erro ao conectar carteira:", error);
                if (error.code === 4001) {
                    alert("Você precisa aprovar a conexão para continuar");
                }
            }
        }

        // Função para verificar rede
        async function checkNetwork() {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            
            if (chainId !== polygonChainId) {
                document.getElementById('networkWarning').style.display = 'block';
                try {
                    // Tenta mudar para a Polygon
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: polygonChainId }],
                    });
                } catch (switchError) {
                    // Se não conseguir, pede para mudar manualmente
                    alert("Por favor conecte-se à Polygon Mainnet no MetaMask");
                }
                return false;
            }
            
            document.getElementById('networkWarning').style.display = 'none';
            return true;
        }

        // Restante das funções permanece igual
        // ...
    </script>
</body>
</html>
