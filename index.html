<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POL Price Proxy - Swap Manual</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding@1.0.1/dist/metamask-onboarding.bundle.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #8247e5;
            text-align: center;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #8247e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px 0;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #6a3cb5;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin: 5px 0 15px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        #accountInfo {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .price-value {
            font-weight: bold;
            color: #8247e5;
        }
        .balance-info {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>POL Price Proxy</h1>
        <p>Swap manual de POL para USDC pelo preço fixo de 312.000 USDC</p>
        
        <div class="section">
            <h2>Conexão com Carteira</h2>
            <button id="connectButton">Conectar MetaMask</button>
            <div id="accountInfo">Não conectado</div>
            <div id="networkInfo"></div>
            <div id="balanceInfo" class="balance-info"></div>
        </div>
        
        <div class="section">
            <h2>Informações de Saldo</h2>
            <div class="price-info">
                <span>Seu saldo de POL:</span>
                <span id="polBalanceDisplay" class="price-value">-</span>
            </div>
            <div class="price-info">
                <span>Preço fixo garantido:</span>
                <span class="price-value">312.000 USDC</span>
            </div>
            <button id="refreshButton">Atualizar Saldo</button>
            <div id="statusMessage" class="status"></div>
        </div>
        
        <div class="section">
            <h2>Swap Manual</h2>
            <label for="polAmount">Quantidade de POL para converter:</label>
            <input type="number" id="polAmount" placeholder="Digite a quantidade" step="0.0001" min="0">
            <button id="swapButton" disabled>Executar Swap</button>
            <div id="swapStatus" class="status"></div>
        </div>
    </div>

    <script>
        // Configurações do contrato
        const CONTRACT_ADDRESS = "0x6Cc8B4a08be3D8e0C7Ef0F4C9eF1cD336f6DDc4d";
        const POL_TOKEN_ADDRESS = "0x455e53CBB86018Ac2B8092FdCd39d8444aFFC3F6";
        
        // ABI simplificada
        const ERC20_ABI = [
            {
                "constant": true,
                "inputs": [{"name": "owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {"name": "spender", "type": "address"},
                    {"name": "amount", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "uint256", "name": "amountPOL", "type": "uint256"}],
                "name": "swapPOLForUSDC",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "togglePriceOverride",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "", "type": "address"}],
                "name": "priceOverrideActive",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Variáveis globais
        let web3;
        let accounts = [];
        let polTokenContract;
        let priceProxyContract;
        let polBalance = 0;
        let polDecimals = 18;

        // Elementos da página
        const connectButton = document.getElementById('connectButton');
        const accountInfo = document.getElementById('accountInfo');
        const networkInfo = document.getElementById('networkInfo');
        const balanceInfo = document.getElementById('balanceInfo');
        const polBalanceDisplay = document.getElementById('polBalanceDisplay');
        const refreshButton = document.getElementById('refreshButton');
        const statusMessage = document.getElementById('statusMessage');
        const swapButton = document.getElementById('swapButton');
        const swapStatus = document.getElementById('swapStatus');
        const polAmountInput = document.getElementById('polAmount');

        // Inicialização
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    initContracts();
                    setupEventListeners();
                    await updateAll();
                } catch (error) {
                    showError(statusMessage, "Erro ao conectar: " + error.message);
                }
            } else {
                showError(statusMessage, "MetaMask não instalado!");
                connectButton.textContent = "Instalar MetaMask";
                connectButton.onclick = () => window.open('https://metamask.io/download.html', '_blank');
            }
        });

        function initContracts() {
            polTokenContract = new web3.eth.Contract(ERC20_ABI, POL_TOKEN_ADDRESS);
            priceProxyContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
            
            // Obter decimais do token POL
            polTokenContract.methods.decimals().call()
                .then(decimals => {
                    polDecimals = decimals;
                })
                .catch(() => {
                    polDecimals = 18; // Valor padrão se não conseguir obter
                });
        }

        function setupEventListeners() {
            // Eventos da MetaMask
            window.ethereum.on('accountsChanged', (newAccounts) => {
                accounts = newAccounts;
                updateAccountInfo();
                updateAll();
            });
            
            window.ethereum.on('chainChanged', () => window.location.reload());
            
            // Botões
            connectButton.addEventListener('click', connectWallet);
            refreshButton.addEventListener('click', updateAll);
            swapButton.addEventListener('click', executeSwap);
            
            // Validação de entrada
            polAmountInput.addEventListener('input', validateSwap);
        }

        async function connectWallet() {
            try {
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                initContracts();
                await updateAll();
            } catch (error) {
                showError(statusMessage, "Erro ao conectar: " + error.message);
            }
        }

        async function updateAll() {
            await checkNetwork();
            updateAccountInfo();
            await updatePolBalance();
            validateSwap();
        }

        async function checkNetwork() {
            try {
                const chainId = await web3.eth.getChainId();
                if (chainId === 137) { // Polygon Mainnet
                    networkInfo.textContent = "Conectado à Polygon Mainnet";
                    networkInfo.style.color = "green";
                    return true;
                } else {
                    networkInfo.textContent = "POR FAVOR, CONECTE À POLYGON MAINNET (ChainID: 137)";
                    networkInfo.style.color = "red";
                    return false;
                }
            } catch (error) {
                console.error("Erro ao verificar rede:", error);
                networkInfo.textContent = "Erro ao verificar rede";
                networkInfo.style.color = "red";
                return false;
            }
        }

        function updateAccountInfo() {
            if (accounts.length > 0) {
                const shortAddress = `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;
                accountInfo.textContent = `Conectado: ${shortAddress}`;
                connectButton.textContent = "Desconectar";
            } else {
                accountInfo.textContent = "Não conectado";
                connectButton.textContent = "Conectar MetaMask";
            }
        }

        async function updatePolBalance() {
            if (accounts.length === 0) {
                polBalance = 0;
                polBalanceDisplay.textContent = "-";
                balanceInfo.textContent = "";
                return;
            }
            
            try {
                polBalance = await polTokenContract.methods.balanceOf(accounts[0]).call();
                const balanceFormatted = web3.utils.fromWei(polBalance, 'ether');
                polBalanceDisplay.textContent = `${parseFloat(balanceFormatted).toFixed(4)} POL`;
                balanceInfo.textContent = `Saldo disponível: ${parseFloat(balanceFormatted).toFixed(4)} POL`;
                
                // Atualizar placeholder do input
                polAmountInput.placeholder = `Máximo: ${parseFloat(balanceFormatted).toFixed(4)} POL`;
                
                clearStatus(statusMessage);
            } catch (error) {
                console.error("Erro ao obter saldo:", error);
                polBalanceDisplay.textContent = "Erro";
                balanceInfo.textContent = "";
                showError(statusMessage, "Erro ao carregar saldo de POL. Verifique a conexão.");
            }
        }

        function validateSwap() {
            if (accounts.length === 0 || polBalance <= 0) {
                swapButton.disabled = true;
                return;
            }
            
            const amount = parseFloat(polAmountInput.value);
            const maxAmount = parseFloat(web3.utils.fromWei(polBalance, 'ether'));
            
            if (!amount || amount <= 0 || amount > maxAmount) {
                swapButton.disabled = true;
                if (amount > maxAmount) {
                    showError(swapStatus, `Quantidade excede seu saldo de ${maxAmount.toFixed(4)} POL`);
                } else {
                    clearStatus(swapStatus);
                }
            } else {
                swapButton.disabled = false;
                clearStatus(swapStatus);
            }
        }

        async function executeSwap() {
            const amount = polAmountInput.value;
            if (!amount || accounts.length === 0) return;
            
            try {
                swapButton.disabled = true;
                showInfo(swapStatus, "Preparando swap...");
                
                const amountInWei = web3.utils.toWei(amount, 'ether');
                
                // 1. Verificar saldo
                if (BigInt(amountInWei) > BigInt(polBalance)) {
                    throw new Error("Saldo insuficiente");
                }
                
                // 2. Verificar se o preço fixo está ativo
                const isPriceOverrideActive = await priceProxyContract.methods.priceOverrideActive(accounts[0]).call();
                if (!isPriceOverrideActive) {
                    showInfo(swapStatus, "Ativando preço fixo...");
                    await priceProxyContract.methods.togglePriceOverride().send({ from: accounts[0] });
                }
                
                // 3. Aprovar contrato para gastar POL
                showInfo(swapStatus, "Aprovando tokens...");
                await polTokenContract.methods.approve(CONTRACT_ADDRESS, amountInWei).send({ from: accounts[0] });
                
                // 4. Executar swap
                showInfo(swapStatus, "Executando swap...");
                await priceProxyContract.methods.swapPOLForUSDC(amountInWei).send({ from: accounts[0] });
                
                showSuccess(swapStatus, `Swap de ${amount} POL concluído pelo preço fixo de 312.000 USDC!`);
                
                // Atualizar saldo
                await updatePolBalance();
                
            } catch (error) {
                console.error("Erro no swap:", error);
                showError(swapStatus, "Erro: " + (error.message || error));
            } finally {
                swapButton.disabled = false;
                validateSwap();
            }
        }

        // Funções auxiliares
        function showSuccess(element, message) {
            element.textContent = message;
            element.className = "status success";
        }

        function showError(element, message) {
            element.textContent = message;
            element.className = "status error";
        }

        function showInfo(element, message) {
            element.textContent = message;
            element.className = "status info";
        }

        function clearStatus(element) {
            element.textContent = "";
            element.className = "status";
        }
    </script>
</body>
</html>
