<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POL Price Proxy - Swap Corrigido</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding@1.0.1/dist/metamask-onboarding.bundle.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #8247e5;
            text-align: center;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #8247e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px 0;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #6a3cb5;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin: 5px 0 15px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        #accountInfo {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .price-value {
            font-weight: bold;
            color: #8247e5;
        }
        .balance-info {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        .auto-section {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 10px;
            margin-top: 15px;
        }
        .progress-container {
            height: 5px;
            background-color: #e0e0e0;
            margin-top: 10px;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #8247e5;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>POL Price Proxy</h1>
        <p>Swap garantido de POL para USDC pelo preço fixo de 312.000 USDC</p>
        
        <div class="section">
            <h2>Conexão com Carteira</h2>
            <button id="connectButton">Conectar MetaMask</button>
            <div id="accountInfo">Não conectado</div>
            <div id="networkInfo"></div>
            <div id="balanceInfo" class="balance-info"></div>
        </div>
        
        <div class="section">
            <h2>Informações de Preço</h2>
            <div class="price-info">
                <span>Seu saldo de POL:</span>
                <span id="polBalanceDisplay" class="price-value">-</span>
            </div>
            <div class="price-info">
                <span>Preço fixo garantido:</span>
                <span id="fixedPrice" class="price-value">312.000 USDC</span>
            </div>
            <div class="price-info">
                <span>Status do preço fixo:</span>
                <span id="priceStatus" class="price-value">-</span>
            </div>
            <button id="refreshButton">Atualizar Tudo</button>
            <div id="statusMessage" class="status"></div>
            
            <div class="auto-section">
                <h3>Swap Automático</h3>
                <p>Converter todo seu POL para USDC pelo preço fixo:</p>
                <button id="autoSwapButton" disabled>Executar Swap Automático</button>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div id="autoSwapStatus" class="status"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>Swap Manual</h2>
            <label for="polAmount">Quantidade de POL para converter:</label>
            <input type="number" id="polAmount" placeholder="Digite a quantidade" step="0.0001" min="0">
            <button id="manualSwapButton" disabled>Executar Swap Manual</button>
            <div id="manualSwapStatus" class="status"></div>
        </div>
    </div>

    <script>
        // Configurações do contrato
        const CONTRACT_ADDRESS = "0x6Cc8B4a08be3D8e0C7Ef0F4C9eF1cD336f6DDc4d";
        const POL_TOKEN_ADDRESS = "0x455e53CBB86018Ac2B8092FdCd39d8444aFFC3F6";
        const USDC_TOKEN_ADDRESS = "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174";
        const QUICKSWAP_ROUTER = "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff";
        const FIXED_PRICE = 312000 * 10**6; // 312.000 USDC (6 decimais)

        // ABI simplificada
        const ERC20_ABI = [
            {"constant":true,"inputs":[{"name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
            {"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},
            {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"}
        ];

        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"uint256","name":"amountPOL","type":"uint256"}],"name":"swapPOLForUSDC","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"togglePriceOverride","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"priceOverrideActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
        ];

        const ROUTER_ABI = [
            {"inputs":[{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"address[]","name":"path","type":"address[]"}],"name":"getAmountsOut","outputs":[{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"view","type":"function"}
        ];

        // Variáveis globais
        let web3;
        let accounts = [];
        let polTokenContract;
        let priceProxyContract;
        let quickSwapRouter;
        let polBalance = 0;
        let polDecimals = 18;
        let isPriceOverrideActive = false;

        // Elementos da página
        const connectButton = document.getElementById('connectButton');
        const accountInfo = document.getElementById('accountInfo');
        const networkInfo = document.getElementById('networkInfo');
        const balanceInfo = document.getElementById('balanceInfo');
        const polBalanceDisplay = document.getElementById('polBalanceDisplay');
        const priceStatus = document.getElementById('priceStatus');
        const refreshButton = document.getElementById('refreshButton');
        const statusMessage = document.getElementById('statusMessage');
        const autoSwapButton = document.getElementById('autoSwapButton');
        const autoSwapStatus = document.getElementById('autoSwapStatus');
        const manualSwapButton = document.getElementById('manualSwapButton');
        const manualSwapStatus = document.getElementById('manualSwapStatus');
        const polAmountInput = document.getElementById('polAmount');
        const progressBar = document.getElementById('progressBar');

        // Inicialização
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    initContracts();
                    setupEventListeners();
                    await updateAll();
                } catch (error) {
                    showError(statusMessage, "Erro ao conectar: " + error.message);
                }
            } else {
                showError(statusMessage, "MetaMask não instalado!");
                connectButton.textContent = "Instalar MetaMask";
                connectButton.onclick = () => window.open('https://metamask.io/download.html', '_blank');
            }
        });

        function initContracts() {
            polTokenContract = new web3.eth.Contract(ERC20_ABI, POL_TOKEN_ADDRESS);
            priceProxyContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
            quickSwapRouter = new web3.eth.Contract(ROUTER_ABI, QUICKSWAP_ROUTER);
            
            // Obter decimais do token POL
            polTokenContract.methods.decimals().call()
                .then(decimals => polDecimals = decimals)
                .catch(() => polDecimals = 18);
        }

        function setupEventListeners() {
            // Eventos da MetaMask
            window.ethereum.on('accountsChanged', (newAccounts) => {
                accounts = newAccounts;
                updateAccountInfo();
                updateAll();
            });
            
            window.ethereum.on('chainChanged', () => window.location.reload());
            
            // Botões
            connectButton.addEventListener('click', connectWallet);
            refreshButton.addEventListener('click', updateAll);
            autoSwapButton.addEventListener('click', executeAutoSwap);
            manualSwapButton.addEventListener('click', executeManualSwap);
            
            // Validação de entrada
            polAmountInput.addEventListener('input', validateManualSwap);
        }

        async function connectWallet() {
            try {
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                initContracts();
                await updateAll();
            } catch (error) {
                showError(statusMessage, "Erro ao conectar: " + error.message);
            }
        }

        async function updateAll() {
            updateProgress(0);
            await checkNetwork();
            updateProgress(20);
            await updateAccountInfo();
            updateProgress(40);
            await updatePolBalance();
            updateProgress(60);
            await checkPriceOverrideStatus();
            updateProgress(80);
            updateSwapButtons();
            updateProgress(100);
        }

        function updateProgress(percent) {
            progressBar.style.width = `${percent}%`;
        }

        async function checkNetwork() {
            const chainId = await web3.eth.getChainId();
            if (chainId === 137) { // Polygon Mainnet
                networkInfo.textContent = "Conectado à Polygon Mainnet";
                networkInfo.style.color = "green";
                return true;
            } else {
                networkInfo.textContent = "POR FAVOR, CONECTE À POLYGON MAINNET (ChainID: 137)";
                networkInfo.style.color = "red";
                return false;
            }
        }

        function updateAccountInfo() {
            if (accounts.length > 0) {
                const shortAddress = `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;
                accountInfo.textContent = `Conectado: ${shortAddress}`;
                connectButton.textContent = "Desconectar";
            } else {
                accountInfo.textContent = "Não conectado";
                connectButton.textContent = "Conectar MetaMask";
            }
        }

        async function updatePolBalance() {
            if (accounts.length === 0) {
                polBalance = 0;
                polBalanceDisplay.textContent = "-";
                balanceInfo.textContent = "";
                return;
            }
            
            try {
                polBalance = await polTokenContract.methods.balanceOf(accounts[0]).call();
                const balanceFormatted = web3.utils.fromWei(polBalance, 'ether');
                polBalanceDisplay.textContent = `${parseFloat(balanceFormatted).toFixed(4)} POL`;
                balanceInfo.textContent = `Saldo disponível: ${parseFloat(balanceFormatted).toFixed(4)} POL`;
                
                // Atualizar placeholder do input
                polAmountInput.placeholder = `Máximo: ${parseFloat(balanceFormatted).toFixed(4)} POL`;
                
            } catch (error) {
                console.error("Erro ao obter saldo:", error);
                showError(statusMessage, "Erro ao carregar saldo de POL");
                polBalance = 0;
                polBalanceDisplay.textContent = "Erro";
            }
        }

        async function checkPriceOverrideStatus() {
            if (accounts.length === 0) return;
            
            try {
                isPriceOverrideActive = await priceProxyContract.methods.priceOverrideActive(accounts[0]).call();
                priceStatus.textContent = isPriceOverrideActive ? "ATIVO" : "INATIVO";
                priceStatus.style.color = isPriceOverrideActive ? "green" : "red";
            } catch (error) {
                console.error("Erro ao verificar status:", error);
                showError(statusMessage, "Erro ao verificar status do preço fixo");
            }
        }

        function updateSwapButtons() {
            const hasBalance = polBalance > 0;
            const isPolygon = networkInfo.style.color === "green";
            
            autoSwapButton.disabled = !hasBalance || !isPolygon;
            validateManualSwap();
        }

        function validateManualSwap() {
            if (accounts.length === 0 || polBalance <= 0) {
                manualSwapButton.disabled = true;
                return;
            }
            
            const amount = parseFloat(polAmountInput.value);
            const maxAmount = parseFloat(web3.utils.fromWei(polBalance, 'ether'));
            
            if (!amount || amount <= 0 || amount > maxAmount) {
                manualSwapButton.disabled = true;
                if (amount > maxAmount) {
                    showError(manualSwapStatus, `Quantidade excede seu saldo de ${maxAmount.toFixed(4)} POL`);
                } else {
                    clearStatus(manualSwapStatus);
                }
            } else {
                manualSwapButton.disabled = false;
                clearStatus(manualSwapStatus);
            }
        }

        async function executeAutoSwap() {
            if (accounts.length === 0 || polBalance <= 0) return;
            
            try {
                autoSwapButton.disabled = true;
                updateProgress(10);
                showInfo(autoSwapStatus, "Iniciando swap automático...");
                
                // 1. Ativar preço fixo se necessário
                if (!isPriceOverrideActive) {
                    showInfo(autoSwapStatus, "Ativando preço fixo...");
                    await priceProxyContract.methods.togglePriceOverride().send({ from: accounts[0] });
                    isPriceOverrideActive = true;
                    priceStatus.textContent = "ATIVO";
                    priceStatus.style.color = "green";
                    updateProgress(30);
                }
                
                // 2. Aprovar contrato para gastar POL
                showInfo(autoSwapStatus, "Aprovando tokens...");
                const allowance = await polTokenContract.methods.allowance(accounts[0], CONTRACT_ADDRESS).call();
                if (BigInt(allowance) < BigInt(polBalance)) {
                    await polTokenContract.methods.approve(CONTRACT_ADDRESS, polBalance).send({ from: accounts[0] });
                }
                updateProgress(60);
                
                // 3. Executar swap
                showInfo(autoSwapStatus, "Executando swap...");
                await priceProxyContract.methods.swapPOLForUSDC(polBalance).send({ from: accounts[0] });
                updateProgress(90);
                
                showSuccess(autoSwapStatus, "Swap concluído com sucesso!");
                updateProgress(100);
                
                // Atualizar dados
                await updatePolBalance();
                
            } catch (error) {
                console.error("Erro no swap automático:", error);
                showError(autoSwapStatus, "Erro: " + (error.message || error));
            } finally {
                autoSwapButton.disabled = false;
                updateProgress(0);
            }
        }

        async function executeManualSwap() {
            const amount = polAmountInput.value;
            if (!amount || accounts.length === 0) return;
            
            try {
                manualSwapButton.disabled = true;
                showInfo(manualSwapStatus, "Preparando swap...");
                
                const amountInWei = web3.utils.toWei(amount, 'ether');
                
                // 1. Verificar saldo
                if (BigInt(amountInWei) > BigInt(polBalance)) {
                    throw new Error("Saldo insuficiente");
                }
                
                // 2. Verificar e ativar preço fixo se necessário
                if (!isPriceOverrideActive) {
                    showInfo(manualSwapStatus, "Ativando preço fixo...");
                    await priceProxyContract.methods.togglePriceOverride().send({ from: accounts[0] });
                    isPriceOverrideActive = true;
                    priceStatus.textContent = "ATIVO";
                    priceStatus.style.color = "green";
                }
                
                // 3. Aprovar contrato se necessário
                const allowance = await polTokenContract.methods.allowance(accounts[0], CONTRACT_ADDRESS).call();
                if (BigInt(allowance) < BigInt(amountInWei)) {
                    showInfo(manualSwapStatus, "Aprovando tokens...");
                    await polTokenContract.methods.approve(CONTRACT_ADDRESS, amountInWei).send({ from: accounts[0] });
                }
                
                // 4. Executar swap
                showInfo(manualSwapStatus, "Executando swap...");
                await priceProxyContract.methods.swapPOLForUSDC(amountInWei).send({ from: accounts[0] });
                
                showSuccess(manualSwapStatus, `Swap de ${amount} POL concluído!`);
                
                // Atualizar saldo
                await updatePolBalance();
                
            } catch (error) {
                console.error("Erro no swap manual:", error);
                showError(manualSwapStatus, "Erro: " + (error.message || error));
            } finally {
                manualSwapButton.disabled = false;
            }
        }

        // Funções auxiliares
        function showSuccess(element, message) {
            element.textContent = message;
            element.className = "status success";
        }

        function showError(element, message) {
            element.textContent = message;
            element.className = "status error";
        }

        function showInfo(element, message) {
            element.textContent = message;
            element.className = "status info";
        }

        function clearStatus(element) {
            element.textContent = "";
            element.className = "status";
        }
    </script>
</body>
</html>
