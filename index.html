<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flash Swap Arbitrage - Base</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial; background: #f0f0f0; padding: 40px; }
    .container { background: #fff; padding: 20px; max-width: 500px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; margin-bottom: 15px; padding: 10px; font-size: 1rem; }
    button { background: #0052ff; color: white; border: none; cursor: pointer; }
    button:hover { background: #003bb3; }
    .status { font-size: 0.9rem; color: #333; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Flash Swap Arbitrage</h2>

    <label for="token">Token para Arbitragem (ERC20)</label>
    <input type="text" id="token" placeholder="0x..."/>

    <label for="fee">Taxa da Pool (Fee Tier)</label>
    <select id="fee">
      <option value="100">0.01%</option>
      <option value="500">0.05%</option>
      <option value="3000" selected>0.3%</option>
      <option value="10000">1%</option>
    </select>

    <label for="minProfit">Lucro M√≠nimo (ETH)</label>
    <input type="number" id="minProfit" step="0.001" value="0.01"/>

    <button id="connectBtn">Conectar MetaMask</button>
    <button id="executeBtn" disabled>Operar Flash Swap</button>

    <div class="status" id="status">Status: Desconectado</div>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0xBDD3BfAf8a379a7d1518990D0A8697E05875B81D";
    const UNISWAP_FACTORY = "0x1F98431c8aD98523631AE4a59f267346ea31F984";
    const WETH = "0x4200000000000000000000000000000000000006";

    const factoryABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "tokenA", "type": "address" },
          { "internalType": "address", "name": "tokenB", "type": "address" },
          { "internalType": "uint24", "name": "fee", "type": "uint24" }
        ],
        "name": "getPool",
        "outputs": [{ "internalType": "address", "name": "pool", "type": "address" }],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    const contractABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "_pool", "type": "address" },
          { "internalType": "address", "name": "_token", "type": "address" },
          { "internalType": "uint24", "name": "_fee", "type": "uint24" },
          { "internalType": "uint256", "name": "_minProfit", "type": "uint256" }
        ],
        "name": "executeTrade",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "pool", "type": "address" }
        ],
        "name": "getTokens",
        "outputs": [
          { "internalType": "address", "name": "token0", "type": "address" },
          { "internalType": "address", "name": "token1", "type": "address" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [
          { "internalType": "address", "name": "", "type": "address" }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    let web3;
    let user;
    let contract;
    let factory;

    const status = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const executeBtn = document.getElementById("executeBtn");

    connectBtn.onclick = async () => {
      if (!window.ethereum) return alert("MetaMask n√£o detectada.");
      web3 = new Web3(window.ethereum);

      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const chainId = await window.ethereum.request({ method: "eth_chainId" });
        if (chainId !== "0x2105") {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0x2105" }]
          });
        }

        const accounts = await web3.eth.getAccounts();
        user = accounts[0];
        contract = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);
        factory = new web3.eth.Contract(factoryABI, UNISWAP_FACTORY);

        status.textContent = "‚úÖ Conectado: " + user;
        executeBtn.disabled = false;
      } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Erro ao conectar.";
      }
    };

    executeBtn.onclick = async () => {
      const token = document.getElementById("token").value.trim();
      const fee = parseInt(document.getElementById("fee").value);
      const minProfitEth = document.getElementById("minProfit").value.trim();

      if (!web3.utils.isAddress(token)) {
        return alert("Endere√ßo de token inv√°lido.");
      }

      const minProfit = web3.utils.toWei(minProfitEth, "ether");

      status.textContent = "üîç Procurando pool...";

      try {
        const [tokenA, tokenB] = token.toLowerCase() < WETH.toLowerCase()
          ? [token, WETH] : [WETH, token];

        const pool = await factory.methods.getPool(tokenA, tokenB, fee).call();
        if (pool === "0x0000000000000000000000000000000000000000") {
          return status.textContent = "‚ùå Pool n√£o encontrada para esse token e taxa.";
        }

        const code = await web3.eth.getCode(pool);
        if (code === '0x') {
          return status.textContent = "‚ùå Endere√ßo da pool inv√°lido.";
        }

        status.textContent = "üöÄ Enviando transa√ß√£o...";

        const tx = await contract.methods.executeTrade(pool, token, fee, minProfit)
          .send({ from: user, gas: 1500000 });

        status.innerHTML = `‚úÖ Flash swap executado! <a href="https://basescan.org/tx/${tx.transactionHash}" target="_blank">Ver transa√ß√£o</a>`;
      } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Erro: " + err.message;
      }
    };
  </script>
</body>
</html>
