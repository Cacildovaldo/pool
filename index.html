<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POL Price Proxy - Swap Fixo para 312k USDC</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@metamask/onboarding@1.0.1/dist/metamask-onboarding.bundle.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #8247e5;
            text-align: center;
        }
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #8247e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px 0;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #6a3cb5;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin: 5px 0 15px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        #accountInfo {
            font-weight: bold;
            margin-bottom: 15px;
        }
        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .price-value {
            font-weight: bold;
            color: #8247e5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>POL Price Proxy</h1>
        <p>Swap de POL para USDC com preço fixo de 312.000 USDC quando o preço de mercado for menor</p>
        
        <div class="section">
            <h2>Conexão com Carteira</h2>
            <button id="connectButton">Conectar MetaMask</button>
            <div id="accountInfo"></div>
            <div id="networkInfo"></div>
        </div>
        
        <div class="section">
            <h2>Informações de Preço</h2>
            <div class="price-info">
                <span>Preço de mercado POL/USDC:</span>
                <span id="marketPrice" class="price-value">-</span>
            </div>
            <div class="price-info">
                <span>Preço fixo no contrato:</span>
                <span id="fixedPrice" class="price-value">312.000 USDC</span>
            </div>
            <div class="price-info">
                <span>Status do preço fixo:</span>
                <span id="priceStatus" class="price-value">-</span>
            </div>
            <button id="checkPriceButton">Verificar Preço Atual</button>
            <button id="toggleOverrideButton" disabled>Ativar/Desativar Preço Fixo</button>
            <div id="priceStatusMessage" class="status"></div>
        </div>
        
        <div class="section">
            <h2>Swap de POL para USDC</h2>
            <label for="polAmount">Quantidade de POL para swap:</label>
            <input type="number" id="polAmount" placeholder="Ex: 1.0" step="any">
            <button id="swapButton" disabled>Executar Swap</button>
            <div id="swapStatus" class="status"></div>
        </div>
    </div>

    <script>
        // ABI do contrato
        const contractABI = [
            {
                "inputs": [],
                "name": "POL_TOKEN",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "USDC_TOKEN",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "QUICKSWAP_ROUTER",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "FIXED_PRICE",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "", "type": "address"}],
                "name": "priceOverrideActive",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "amountPOL", "type": "uint256"}],
                "name": "swapPOLForUSDC",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "togglePriceOverride",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Endereço do contrato na Polygon
        const contractAddress = "0x6Cc8B4a08be3D8e0C7Ef0F4C9eF1cD336f6DDc4d";
        
        // ABI do token ERC20 (simplificado)
        const erc20ABI = [
            {
                "constant": false,
                "inputs": [
                    {"name": "spender", "type": "address"},
                    {"name": "value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{"name": "", "type": "uint8"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [{"name": "owner", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"name": "", "type": "uint256"}],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // ABI do QuickSwap Router (simplificado)
        const quickSwapRouterABI = [
            {
                "inputs": [
                    {"internalType": "uint256", "name": "amountIn", "type": "uint256"},
                    {"internalType": "address[]", "name": "path", "type": "address[]"}
                ],
                "name": "getAmountsOut",
                "outputs": [{"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let web3;
        let accounts = [];
        let contract;
        let polTokenContract;
        let usdcTokenContract;
        let quickSwapRouterContract;
        let isOverrideActive = false;
        let currentMarketPrice = 0;

        // Elementos da página
        const connectButton = document.getElementById('connectButton');
        const accountInfo = document.getElementById('accountInfo');
        const networkInfo = document.getElementById('networkInfo');
        const checkPriceButton = document.getElementById('checkPriceButton');
        const toggleOverrideButton = document.getElementById('toggleOverrideButton');
        const swapButton = document.getElementById('swapButton');
        const polAmountInput = document.getElementById('polAmount');
        const marketPriceDisplay = document.getElementById('marketPrice');
        const priceStatusDisplay = document.getElementById('priceStatus');
        const priceStatusMessage = document.getElementById('priceStatusMessage');
        const swapStatus = document.getElementById('swapStatus');

        // Inicialização
        window.addEventListener('load', async () => {
            // Verificar se MetaMask está instalado
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                
                try {
                    // Solicitar acesso à conta
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    updateAccountInfo();
                    
                    // Inicializar contratos
                    initializeContracts();
                    
                    // Verificar rede
                    checkNetwork();
                    
                    // Configurar listeners
                    setupEventListeners();
                    
                } catch (error) {
                    console.error("Erro ao conectar à MetaMask:", error);
                    showError(priceStatusMessage, "Erro ao conectar à MetaMask: " + error.message);
                }
            } else {
                showError(priceStatusMessage, "MetaMask não detectado. Por favor, instale a extensão.");
                connectButton.textContent = "Instalar MetaMask";
                connectButton.onclick = () => {
                    window.open('https://metamask.io/download.html', '_blank');
                };
            }
        });

        function initializeContracts() {
            contract = new web3.eth.Contract(contractABI, contractAddress);
            
            // Obter endereços dos tokens e router do contrato
            contract.methods.POL_TOKEN().call().then(polTokenAddress => {
                polTokenContract = new web3.eth.Contract(erc20ABI, polTokenAddress);
            });
            
            contract.methods.USDC_TOKEN().call().then(usdcTokenAddress => {
                usdcTokenContract = new web3.eth.Contract(erc20ABI, usdcTokenAddress);
            });
            
            contract.methods.QUICKSWAP_ROUTER().call().then(routerAddress => {
                quickSwapRouterContract = new web3.eth.Contract(quickSwapRouterABI, routerAddress);
            });
        }

        function setupEventListeners() {
            // Listener para mudança de conta
            window.ethereum.on('accountsChanged', (newAccounts) => {
                accounts = newAccounts;
                updateAccountInfo();
                checkPriceOverrideStatus();
            });
            
            // Listener para mudança de rede
            window.ethereum.on('chainChanged', (chainId) => {
                window.location.reload();
            });
            
            // Botão de conexão
            connectButton.addEventListener('click', async () => {
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    updateAccountInfo();
                    initializeContracts();
                    checkNetwork();
                } catch (error) {
                    showError(priceStatusMessage, "Erro ao conectar: " + error.message);
                }
            });
            
            // Botão para verificar preço
            checkPriceButton.addEventListener('click', checkMarketPrice);
            
            // Botão para ativar/desativar preço fixo
            toggleOverrideButton.addEventListener('click', togglePriceOverride);
            
            // Botão para executar swap
            swapButton.addEventListener('click', executeSwap);
        }

        function updateAccountInfo() {
            if (accounts.length > 0) {
                const shortAddress = `${accounts[0].substring(0, 6)}...${accounts[0].substring(38)}`;
                accountInfo.textContent = `Conectado como: ${shortAddress}`;
                connectButton.textContent = "Desconectar";
                checkPriceOverrideStatus();
            } else {
                accountInfo.textContent = "Não conectado";
                connectButton.textContent = "Conectar MetaMask";
            }
        }

        function checkNetwork() {
            web3.eth.net.getNetworkType().then(networkType => {
                web3.eth.getChainId().then(chainId => {
                    // Polygon Mainnet chain ID is 137
                    if (chainId === 137) {
                        networkInfo.textContent = "Rede: Polygon Mainnet";
                        networkInfo.style.color = "green";
                        
                        // Habilitar botões após verificação de rede
                        checkPriceButton.disabled = false;
                        toggleOverrideButton.disabled = false;
                        swapButton.disabled = false;
                    } else {
                        networkInfo.textContent = "Por favor, conecte-se à Polygon Mainnet (ChainID: 137)";
                        networkInfo.style.color = "red";
                        
                        // Desabilitar botões se não for Polygon
                        checkPriceButton.disabled = true;
                        toggleOverrideButton.disabled = true;
                        swapButton.disabled = true;
                    }
                });
            });
        }

        async function checkPriceOverrideStatus() {
            if (accounts.length === 0) return;
            
            try {
                const status = await contract.methods.priceOverrideActive(accounts[0]).call();
                isOverrideActive = status;
                priceStatusDisplay.textContent = status ? "ATIVO" : "INATIVO";
                priceStatusDisplay.style.color = status ? "green" : "red";
                
                // Verificar o preço de mercado
                await checkMarketPrice();
            } catch (error) {
                console.error("Erro ao verificar status do preço fixo:", error);
                showError(priceStatusMessage, "Erro ao verificar status: " + error.message);
            }
        }

        async function checkMarketPrice() {
            if (!quickSwapRouterContract || !contract) return;
            
            try {
                // Obter endereços dos tokens do contrato
                const polTokenAddress = await contract.methods.POL_TOKEN().call();
                const usdcTokenAddress = await contract.methods.USDC_TOKEN().call();
                
                // Configurar o path para o swap (POL -> USDC)
                const path = [polTokenAddress, usdcTokenAddress];
                
                // Verificar preço para 1 POL (em USDC)
                const amounts = await quickSwapRouterContract.methods.getAmountsOut(web3.utils.toWei('1', 'ether'), path).call();
                
                // USDC tem 6 decimais
                const usdcAmount = amounts[1] / 10**6;
                currentMarketPrice = usdcAmount;
                
                marketPriceDisplay.textContent = `${usdcAmount.toFixed(6)} USDC`;
                
                // Obter preço fixo do contrato
                const fixedPrice = await contract.methods.FIXED_PRICE().call();
                const fixedPriceInUSDC = fixedPrice / 10**6;
                
                // Verificar se o preço de mercado é menor que o fixo
                if (usdcAmount < fixedPriceInUSDC) {
                    priceStatusMessage.textContent = `Preço de mercado (${usdcAmount.toFixed(6)} USDC) está abaixo do preço fixo (${fixedPriceInUSDC} USDC). Você pode ativar o preço fixo.`;
                    priceStatusMessage.className = "status info";
                    toggleOverrideButton.disabled = false;
                } else {
                    priceStatusMessage.textContent = `Preço de mercado (${usdcAmount.toFixed(6)} USDC) está acima do preço fixo (${fixedPriceInUSDC} USDC). Não é recomendado ativar o preço fixo.`;
                    priceStatusMessage.className = "status info";
                    toggleOverrideButton.disabled = false;
                }
                
            } catch (error) {
                console.error("Erro ao verificar preço de mercado:", error);
                showError(priceStatusMessage, "Erro ao verificar preço: " + error.message);
            }
        }

        async function togglePriceOverride() {
            if (accounts.length === 0) return;
            
            try {
                toggleOverrideButton.disabled = true;
                showInfo(priceStatusMessage, "Processando transação...");
                
                await contract.methods.togglePriceOverride().send({ from: accounts[0] });
                
                // Atualizar status após a transação
                await checkPriceOverrideStatus();
                showSuccess(priceStatusMessage, `Preço fixo ${isOverrideActive ? 'ativado' : 'desativado'} com sucesso!`);
                
            } catch (error) {
                console.error("Erro ao alternar preço fixo:", error);
                showError(priceStatusMessage, "Erro ao alternar preço fixo: " + error.message);
            } finally {
                toggleOverrideButton.disabled = false;
            }
        }

        async function executeSwap() {
            if (accounts.length === 0 || !polAmountInput.value) return;
            
            try {
                swapButton.disabled = true;
                showInfo(swapStatus, "Iniciando swap...");
                
                const polAmount = polAmountInput.value;
                const polAmountInWei = web3.utils.toWei(polAmount, 'ether');
                
                // Verificar saldo
                const polBalance = await polTokenContract.methods.balanceOf(accounts[0]).call();
                if (BigInt(polBalance) < BigInt(polAmountInWei)) {
                    throw new Error("Saldo insuficiente de POL");
                }
                
                // Verificar aprovação
                const allowance = await polTokenContract.methods.allowance(accounts[0], contractAddress).call();
                if (BigInt(allowance) < BigInt(polAmountInWei)) {
                    showInfo(swapStatus, "Aprovando tokens POL para o contrato...");
                    await polTokenContract.methods.approve(contractAddress, polAmountInWei).send({ from: accounts[0] });
                }
                
                // Executar swap
                showInfo(swapStatus, "Executando swap...");
                await contract.methods.swapPOLForUSDC(polAmountInWei).send({ from: accounts[0] });
                
                showSuccess(swapStatus, `Swap de ${polAmount} POL para USDC executado com sucesso!`);
                
            } catch (error) {
                console.error("Erro ao executar swap:", error);
                showError(swapStatus, "Erro no swap: " + (error.message || error));
            } finally {
                swapButton.disabled = false;
            }
        }

        // Funções auxiliares para exibir mensagens
        function showSuccess(element, message) {
            element.textContent = message;
            element.className = "status success";
        }

        function showError(element, message) {
            element.textContent = message;
            element.className = "status error";
        }

        function showInfo(element, message) {
            element.textContent = message;
            element.className = "status info";
        }
    </script>
</body>
</html>
