<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Bot - Polygon</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { padding: 10px 15px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; font-weight: bold; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        input, select { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #dff0d8; color: #3c763d; }
        .error { background-color: #f2dede; color: #a94442; }
        .loading { color: #31708f; }
        h1 { color: #2c3e50; }
        h2 { color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    </style>
</head>
<body>
    <h1>üîÑ Arbitrage Bot - Polygon</h1>
    
    <div class="panel">
        <h2>üîê Carteira</h2>
        <button id="connectWallet">üîó Conectar Carteira</button>
        <div id="walletAddress" style="margin-top: 10px;"></div>
        <div id="networkInfo" class="status"></div>
        
        <h2 style="margin-top: 20px;">‚öôÔ∏è Configura√ß√£o do Contrato</h2>
        <input type="text" id="contractAddress" placeholder="Cole o endere√ßo do contrato (e.g., 0x5939F7300D749D71900b1159c6Bb9B58990041CA)" value="0x5939F7300D749D71900b1159c6Bb9B58990041CA" style="margin-bottom: 10px;">
        <button id="loadContract">Carregar Contrato</button>
        <div id="contractStatus" class="status"></div>
        <p style="margin-top: 10px; font-size: 0.9em; color: #555;">
            Este contrato j√° vem com os endere√ßos dos roteadores (Uniswap, SushiSwap, QuickSwap) pr√©-configurados no construtor.
            N√£o √© necess√°rio chamar `updateRouter` ap√≥s a implanta√ß√£o.
        </p>
    </div>
    
    <div class="container">
        <div class="panel">
            <h2>üîç Buscar Oportunidades</h2>
            <div>
                <label>Token:</label>
                <select id="tokenSelect">
                    <option value="WMATIC">WMATIC</option>
                    <option value="USDC">USDC</option>
                </select>
            </div>
            <button id="searchPrices" style="margin-top: 10px;">Buscar Pre√ßos</button>
            <div id="priceResults" style="margin-top: 15px;"></div>
        </div>
        
        <div class="panel">
            <h2>‚ö° Executar Arbitragem</h2>
            <div id="arbitragePanel" style="display: none;">
                <div>
                    <label>Token:</label>
                    <select id="arbTokenSelect">
                        <option value="WMATIC">WMATIC</option>
                        <option value="USDC">USDC</option>
                    </select>
                </div>
                <div>
                    <label>Comprar em:</label>
                    <select id="buyDex">
                        <option value="uniswap">Uniswap</option>
                        <option value="sushiswap">SushiSwap</option>
                        <option value="quickswap">QuickSwap</option>
                    </select>
                </div>
                <div>
                    <label>Vender em:</label>
                    <select id="sellDex">
                        <option value="uniswap">Uniswap</option>
                        <option value="sushiswap">SushiSwap</option>
                        <option value="quickswap">QuickSwap</option>
                    </select>
                </div>
                <div>
                    <label>Quantidade (MATIC):</label>
                    <input type="number" id="amountIn" min="0.01" step="0.01" value="1.0">
                </div>
                <div>
                    <label>Lucro m√≠nimo esperado (MATIC):</label>
                    <input type="number" id="minProfit" min="0" step="0.01" value="0.01">
                </div>
                <button id="executeArbitrage">Executar Arbitragem</button>
                <div id="transactionStatus" class="status" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ABI do contrato (ser√° preenchida automaticamente)
        const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"executor","type":"address"},{"indexed":false,"internalType":"string","name":"token","type":"string"},{"indexed":false,"internalType":"uint256","name":"amountIn","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"profit","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"}],"name":"ArbitrageExecuted","type":"event"},{"inputs":[],"name":"USDC","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"WMATIC","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"buyDex","type":"string"},{"internalType":"string","name":"sellDex","type":"string"},{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"uint256","name":"expectedProfit","type":"uint256"}],"name":"executeMaticArbitrage","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"buyDex","type":"string"},{"internalType":"string","name":"sellDex","type":"string"},{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"uint256","name":"expectedProfit","type":"uint256"}],"name":"executeUsdcArbitrage","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"config","outputs":[{"internalType":"uint256","name":"minProfit","type":"uint256"},{"internalType":"uint256","name":"maxSlippage","type":"uint256"},{"internalType":"uint256","name":"fee","type":"uint256"},{"internalType":"address","name":"feeReceiver","type":"address"},{"internalType":"bool","name":"enabled","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"recoverFunds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"routers","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"enabled","type":"bool"}],"name":"toggleArbitrage","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"minProfit","type":"uint256"},{"internalType":"uint256","name":"maxSlippage","type":"uint256"},{"internalType":"uint256","name":"fee","type":"uint256"},{"internalType":"address","name":"feeReceiver","type":"address"},{"internalType":"bool","name":"enabled","type":"bool"}],"name":"updateConfig","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"name","type":"string"},{"internalType":"address","name":"router","type":"address"}],"name":"updateRouter","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

        // Endere√ßos dos routers para Polygon Mainnet.
        // Estes endere√ßos DEVEM corresponder aos hardcoded no construtor do seu contrato Solidity.
        // Nota: O Uniswap V3 Universal Router (0xE592427A0AEce92De3Edee1F18E0157C05861564) N√ÉO √© compat√≠vel
        // com as chamadas de swapExactETHForTokens e swapExactTokensForETH do seu contrato.
        // Para compatibilidade, estou usando o QuickSwap Router para a chave "uniswap"
        // j√° que ele √© um fork V2 e suas fun√ß√µes s√£o compat√≠veis com seu contrato.
        const ROUTERS = {
            uniswap: "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff", // QuickSwap Router (V2)
            sushiswap: "0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506", // SushiSwap Router (V2)
            quickswap: "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff" // QuickSwap Router (V2)
        };

        let web3;
        let contract;
        let account;

        // Conectar carteira
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    const btn = document.getElementById('connectWallet');
                    btn.disabled = true;
                    btn.textContent = "Conectando...";
                    
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    
                    const accounts = await web3.eth.getAccounts();
                    account = accounts[0];
                    document.getElementById('walletAddress').innerHTML = 
                        `<strong>Conectado:</strong> ${account.substring(0, 6)}...${account.substring(38)}`;
                    
                    // Verificar rede
                    const chainId = await web3.eth.getChainId();
                    if (chainId !== 137) {
                        document.getElementById('networkInfo').textContent = "‚ùå Conecte-se √† Polygon (ChainID: 137)";
                        document.getElementById('networkInfo').className = "status error";
                        // Adicionar sugest√£o para trocar de rede
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: web3.utils.toHex(137) }],
                            });
                            // Se a troca for bem-sucedida, a p√°gina recarregar√° via 'chainChanged' listener
                        } catch (switchError) {
                            console.error("Erro ao tentar trocar de rede:", switchError);
                            // O usu√°rio pode ter recusado a troca ou a rede n√£o est√° configurada
                        }
                    } else {
                        document.getElementById('networkInfo').textContent = "‚úÖ Conectado √† Polygon Mainnet";
                        document.getElementById('networkInfo').className = "status success";
                        document.getElementById('arbitragePanel').style.display = 'block';
                        
                        // Tenta carregar o contrato automaticamente se o endere√ßo estiver preenchido
                        const contractAddressInput = document.getElementById('contractAddress');
                        if (contractAddressInput.value && web3.utils.isAddress(contractAddressInput.value)) {
                            await loadContractFunction(contractAddressInput.value);
                        }
                    }
                    
                    btn.textContent = "‚úÖ Carteira Conectada";
                } catch (error) {
                    console.error("Erro ao conectar:", error);
                    document.getElementById('connectWallet').textContent = "üîó Conectar Carteira";
                    document.getElementById('connectWallet').disabled = false;
                    document.getElementById('networkInfo').textContent = "Erro: " + error.message;
                    document.getElementById('networkInfo').className = "status error";
                }
            } else {
                alert('Por favor, instale MetaMask!');
            }
        });

        // Fun√ß√£o auxiliar para carregar contrato
        async function loadContractFunction(address) {
            const statusDiv = document.getElementById('contractStatus');
            try {
                statusDiv.textContent = "Carregando contrato...";
                statusDiv.className = "status loading";
                
                contract = new web3.eth.Contract(CONTRACT_ABI, address);
                
                // Testar uma chamada simples
                const owner = await contract.methods.owner().call();
                
                statusDiv.textContent = `‚úÖ Contrato carregado (Owner: ${owner.substring(0, 6)}...)`;
                statusDiv.className = "status success";
                document.getElementById('arbitragePanel').style.display = 'block';
            } catch (error) {
                console.error("Erro ao carregar contrato:", error);
                statusDiv.textContent = "Erro ao carregar contrato: " + error.message;
                statusDiv.className = "status error";
            }
        }

        // Carregar contrato (evento de clique)
        document.getElementById('loadContract').addEventListener('click', async () => {
            const contractAddress = document.getElementById('contractAddress').value.trim();
            const statusDiv = document.getElementById('contractStatus');
            
            if (!web3) {
                statusDiv.textContent = "Conecte sua carteira primeiro!";
                statusDiv.className = "status error";
                return;
            }
            
            if (!web3.utils.isAddress(contractAddress)) {
                statusDiv.textContent = "Endere√ßo do contrato inv√°lido!";
                statusDiv.className = "status error";
                return;
            }
            await loadContractFunction(contractAddress);
        });

        // Buscar pre√ßos (simula√ß√£o)
        document.getElementById('searchPrices').addEventListener('click', async () => {
            if (!contract) {
                showError("Carregue o contrato primeiro!");
                return;
            }
            
            const token = document.getElementById('tokenSelect').value;
            const resultsDiv = document.getElementById('priceResults');
            resultsDiv.innerHTML = "<p>Buscando pre√ßos...</p>";
            
            // Simula√ß√£o - em produ√ß√£o voc√™ chamaria or√°culos ou APIs
            setTimeout(() => {
                const prices = {
                    WMATIC: {
                        uniswap: (1 + Math.random() * 0.02).toFixed(4),
                        sushiswap: (0.99 + Math.random() * 0.02).toFixed(4),
                        quickswap: (1.01 + Math.random() * 0.02).toFixed(4)
                    },
                    USDC: {
                        uniswap: (1.001 + Math.random() * 0.001).toFixed(4),
                        sushiswap: (0.999 + Math.random() * 0.001).toFixed(4),
                        quickswap: (1.002 + Math.random() * 0.001).toFixed(4)
                    }
                };
                
                const tokenPrices = prices[token];
                const minPrice = Math.min(...Object.values(tokenPrices));
                const maxPrice = Math.max(...Object.values(tokenPrices));
                const difference = ((maxPrice - minPrice) / minPrice * 100).toFixed(2);
                
                resultsDiv.innerHTML = `
                    <h3>Pre√ßos para ${token}</h3>
                    <p>Uniswap: ${tokenPrices.uniswap}</p>
                    <p>SushiSwap: ${tokenPrices.sushiswap}</p>
                    <p>QuickSwap: ${tokenPrices.quickswap}</p>
                    <p><strong>Diferen√ßa: ${difference}%</strong></p>
                    ${difference > 1 ? '<p style="color:green;">Oportunidade de arbitragem detectada!</p>' : ''}
                `;
            }, 1000);
        });

        // Executar arbitragem
        document.getElementById('executeArbitrage').addEventListener('click', async () => {
            if (!contract || !account) {
                showError("Conecte sua carteira e carregue o contrato!");
                return;
            }
            
            const token = document.getElementById('arbTokenSelect').value;
            const buyDex = document.getElementById('buyDex').value;
            const sellDex = document.getElementById('sellDex').value;
            const amountIn = document.getElementById('amountIn').value;
            const minProfit = document.getElementById('minProfit').value; // Este √© o expectedProfit para o contrato
            const statusDiv = document.getElementById('transactionStatus');
            
            if (!amountIn || parseFloat(amountIn) <= 0) { // Usar parseFloat para comparar
                showError("Insira uma quantidade v√°lida!");
                return;
            }
            if (!minProfit || parseFloat(minProfit) < 0) {
                 showError("Insira um lucro m√≠nimo esperado v√°lido (>= 0)!");
                 return;
            }
            
            try {
                const btn = document.getElementById('executeArbitrage');
                btn.disabled = true;
                statusDiv.textContent = "Preparando transa√ß√£o...";
                statusDiv.className = "status loading";
                
                const amountWei = web3.utils.toWei(amountIn, 'ether');
                const minProfitWei = web3.utils.toWei(minProfit, 'ether'); // Convertendo para WEI
                
                let tx;
                if (token === "WMATIC") {
                    tx = await contract.methods.executeMaticArbitrage(
                        buyDex,
                        sellDex,
                        amountWei,
                        minProfitWei // Passando o lucro m√≠nimo esperado
                    ).send({
                        from: account,
                        value: amountWei // Valor de MATIC a ser enviado para o contrato
                    });
                } else {
                    tx = await contract.methods.executeUsdcArbitrage(
                        buyDex,
                        sellDex,
                        amountWei,
                        minProfitWei // Passando o lucro m√≠nimo esperado
                    ).send({
                        from: account,
                        value: amountWei
                    });
                }
                
                statusDiv.innerHTML = `‚úÖ <strong>Sucesso!</strong> TX: <a href="https://polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash.substring(0, 10)}...</a>`;
                statusDiv.className = "status success";
            } catch (error) {
                console.error("Erro na arbitragem:", error);
                let errorMessage = "Ocorreu um erro desconhecido.";
                if (error.message) {
                    errorMessage = error.message.split("\n")[0];
                } else if (error.data && error.data.message) {
                    errorMessage = error.data.message;
                }
                statusDiv.textContent = "‚ùå Erro: " + errorMessage;
                statusDiv.className = "status error";
            } finally {
                document.getElementById('executeArbitrage').disabled = false;
            }
        });

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = "status error";
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // Configurar mudan√ßa de rede
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => window.location.reload());
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    window.location.reload();
                } else {
                    account = accounts[0];
                    document.getElementById('walletAddress').innerHTML = 
                        `<strong>Conectado:</strong> ${account.substring(0, 6)}...${account.substring(38)}`;
                }
            });
        }

        // Carregar automaticamente o contrato se o endere√ßo estiver preenchido e a carteira j√° estiver conectada
        // Isso √© executado quando a p√°gina carrega e a carteira j√° est√° conectada (e.g., depois de um refresh)
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                // Tentar conectar a carteira automaticamente
                try {
                    web3 = new Web3(window.ethereum);
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        account = accounts[0];
                        document.getElementById('walletAddress').innerHTML = 
                            `<strong>Conectado:</strong> ${account.substring(0, 6)}...${account.substring(38)}`;
                        const chainId = await web3.eth.getChainId();
                        if (chainId === 137) {
                            document.getElementById('networkInfo').textContent = "‚úÖ Conectado √† Polygon Mainnet";
                            document.getElementById('networkInfo').className = "status success";
                            document.getElementById('arbitragePanel').style.display = 'block';
                            
                            const contractAddressInput = document.getElementById('contractAddress');
                            if (contractAddressInput.value && web3.utils.isAddress(contractAddressInput.value)) {
                                await loadContractFunction(contractAddressInput.value);
                            }
                        } else {
                            document.getElementById('networkInfo').textContent = "‚ùå Conecte-se √† Polygon (ChainID: 137)";
                            document.getElementById('networkInfo').className = "status error";
                        }
                        document.getElementById('connectWallet').textContent = "‚úÖ Carteira Conectada";
                        document.getElementById('connectWallet').disabled = true;
                    }
                } catch (error) {
                    console.error("Erro ao carregar automaticamente:", error);
                }
            }
        });
    </script>
</body>
</html>
