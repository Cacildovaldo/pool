<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bot de Compra e Venda - Uniswap V3 Base</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial; background: #f8f8f8; padding: 40px; }
    .container { background: #fff; padding: 20px; max-width: 500px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; margin-bottom: 15px; padding: 10px; font-size: 1rem; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    .status { font-size: 0.9rem; margin-top: 10px; color: #333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Operador de Compra/Venda Automática</h2>

    <label for="contract">Endereço do Contrato</label>
    <input type="text" id="contract" placeholder="0xe2600f67728EC87932a4A97D866232D39a662076">

    <label for="token">Token Alvo (ERC20)</label>
    <input type="text" id="token" placeholder="0x...">

    <label for="fee">Fee Tier da Pool (Uniswap V3)</label>
    <select id="fee">
      <option value="100">0.01%</option>
      <option value="500" selected>0.05%</option>
      <option value="3000">0.3%</option>
      <option value="10000">1%</option>
    </select>

    <label for="ethValue">Valor em ETH para operar</label>
    <input type="number" id="ethValue" placeholder="0.01" step="0.001">

    <label for="minOut">Valor mínimo de retorno (ETH)</label>
    <input type="number" id="minOut" placeholder="0.005" step="0.001">

    <button id="connectBtn">Conectar MetaMask</button>
    <button id="executeBtn" disabled>Operar</button>

    <div class="status" id="status">Status: Aguardando...</div>
  </div>

  <script>
    const abi = [
      {
        "inputs": [
          {"internalType": "address", "name": "_weth", "type": "address"},
          {"internalType": "address", "name": "_router", "type": "address"}
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "inputs": [
          {"internalType": "address", "name": "token", "type": "address"},
          {"internalType": "uint24", "name": "fee", "type": "uint24"},
          {"internalType": "uint256", "name": "minOut", "type": "uint256"}
        ],
        "name": "buyAndSellToken",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [{"internalType": "address", "name": "", "type": "address"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "anonymous": false,
        "inputs": [
          {"indexed": false, "internalType": "uint256", "name": "ethIn", "type": "uint256"},
          {"indexed": false, "internalType": "uint256", "name": "ethOut", "type": "uint256"},
          {"indexed": false, "internalType": "int256", "name": "profitPercent", "type": "int256"}
        ],
        "name": "OperationComplete",
        "type": "event"
      }
    ];

    let web3;
    let user;
    let contractInstance;

    const connectBtn = document.getElementById("connectBtn");
    const executeBtn = document.getElementById("executeBtn");
    const status = document.getElementById("status");

    connectBtn.onclick = async () => {
      if (!window.ethereum) return alert("MetaMask não encontrada.");
      web3 = new Web3(window.ethereum);

      try {
        await ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        user = accounts[0];
        status.textContent = "✅ Conectado: " + user;
        executeBtn.disabled = false;
      } catch (err) {
        status.textContent = "❌ Falha ao conectar.";
        console.error(err);
      }
    };

    executeBtn.onclick = async () => {
      const contractAddress = document.getElementById("contract").value.trim();
      const token = document.getElementById("token").value.trim();
      const fee = parseInt(document.getElementById("fee").value);
      const ethValue = parseFloat(document.getElementById("ethValue").value);
      const minOut = parseFloat(document.getElementById("minOut").value);

      if (!web3.utils.isAddress(contractAddress) || !web3.utils.isAddress(token)) {
        return alert("Endereços inválidos.");
      }
      if (ethValue <= 0 || minOut <= 0) {
        return alert("Preencha os valores de ETH corretamente.");
      }

      contractInstance = new web3.eth.Contract(abi, contractAddress);

      status.textContent = "⏳ Enviando transação...";

      try {
        const tx = await contractInstance.methods.buyAndSellToken(
          token,
          fee,
          web3.utils.toWei(minOut.toString(), "ether")
        ).send({ from: user, value: web3.utils.toWei(ethValue.toString(), "ether") });

        status.innerHTML = `✅ Operação enviada! <a href="https://basescan.org/tx/${tx.transactionHash}" target="_blank">Ver transação</a>`;
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Erro: " + err.message;
      }
    };
  </script>
</body>
</html>
