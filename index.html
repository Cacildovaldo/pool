<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage Bot - Polygon DEXs</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .wallet-section, .search-section { margin-bottom: 20px; }
        button { padding: 10px 15px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:disabled { background: #cccccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .arbitrage-opportunity { background-color: #e6f7ff; }
        input, select { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        .panel { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Arbitrage Bot - Polygon DEXs</h1>
    
    <div class="panel wallet-section">
        <h2>Carteira</h2>
        <button id="connectWallet">Conectar Carteira</button>
        <div id="walletAddress" style="margin-top: 10px;"></div>
        <div id="networkInfo" style="margin-top: 5px; color: #666;"></div>
    </div>
    
    <div class="panel search-section">
        <h2>Buscar Oportunidades</h2>
        <button id="searchTokens">Buscar em todas as DEXs</button>
        <div style="margin-top: 10px;">
            <label for="tokenFilter">Filtrar por token:</label>
            <input type="text" id="tokenFilter" placeholder="Endereço do token (0x...)">
        </div>
    </div>
    
    <div class="container">
        <div class="panel">
            <h2>Resultados da Busca</h2>
            <table id="pricesTable">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Uniswap</th>
                        <th>SushiSwap</th>
                        <th>QuickSwap</th>
                        <th>Diferença</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="pricesTableBody">
                    <!-- Resultados serão inseridos aqui -->
                </tbody>
            </table>
        </div>
        
        <div class="panel">
            <h2>Executar Arbitragem</h2>
            <div id="arbitragePanel" style="display: none;">
                <div>
                    <label for="buyDex">Comprar em:</label>
                    <select id="buyDex">
                        <option value="uniswap">Uniswap</option>
                        <option value="sushiswap">SushiSwap</option>
                        <option value="quickswap">QuickSwap</option>
                    </select>
                </div>
                <div>
                    <label for="sellDex">Vender em:</label>
                    <select id="sellDex">
                        <option value="uniswap">Uniswap</option>
                        <option value="sushiswap">SushiSwap</option>
                        <option value="quickswap">QuickSwap</option>
                    </select>
                </div>
                <div>
                    <label for="tokenAddress">Token (endereço):</label>
                    <input type="text" id="tokenAddress" placeholder="0x...">
                </div>
                <div>
                    <label for="tokenAmount">Quantidade (MATIC):</label>
                    <input type="number" id="tokenAmount" min="0.01" step="0.01" value="1.0">
                </div>
                <div>
                    <label>Lucro estimado:</label>
                    <span id="expectedProfit">--</span> MATIC
                </div>
                <button id="executeArbitrage" disabled>Executar Arbitragem</button>
                <div id="transactionStatus" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ABI do contrato (copiada diretamente do REMIX após compilação)
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "executor",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "buyRouter",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "sellRouter",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "profit",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "fee",
                        "type": "uint256"
                    }
                ],
                "name": "ArbitrageExecuted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [],
                "name": "ConfigUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "FundsRecovered",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "address",
                        "name": "router",
                        "type": "address"
                    }
                ],
                "name": "RouterUpdated",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "buyDex",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "sellDex",
                        "type": "string"
                    },
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amountIn",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "expectedProfit",
                        "type": "uint256"
                    }
                ],
                "name": "executeArbitrage",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "config",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "minProfit",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "maxSlippage",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "fee",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "feeReceiver",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "enabled",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "recoverFunds",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "name": "routers",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bool",
                        "name": "enabled",
                        "type": "bool"
                    }
                ],
                "name": "toggleArbitrage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "minProfit",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "maxSlippage",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "fee",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "feeReceiver",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "enabled",
                        "type": "bool"
                    }
                ],
                "name": "updateConfig",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "address",
                        "name": "router",
                        "type": "address"
                    }
                ],
                "name": "updateRouter",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];
        
        // Endereços dos routers na Polygon
        const ROUTERS = {
            uniswap: "0xE592427A0AEce92De3Edee1F18E0157C05861564", // Uniswap V3
            sushiswap: "0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506", // SushiSwap
            quickswap: "0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff" // QuickSwap
        };
        
        const WMATIC = "0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270";
        let web3;
        let contract;
        let account;
        let contractAddress;
        
        // Conectar carteira
        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (window.ethereum) {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    
                    // Obter conta
                    const accounts = await web3.eth.getAccounts();
                    account = accounts[0];
                    document.getElementById('walletAddress').textContent = `Conectado: ${account.substring(0, 6)}...${account.substring(38)}`;
                    
                    // Obter network
                    const chainId = await web3.eth.getChainId();
                    if (chainId !== 137) {
                        document.getElementById('networkInfo').textContent = "ERRO: Conecte-se à Polygon (ChainID: 137)";
                        document.getElementById('networkInfo').style.color = "red";
                        return;
                    } else {
                        document.getElementById('networkInfo').textContent = "Conectado à Polygon Mainnet";
                        document.getElementById('networkInfo').style.color = "green";
                    }
                    
                    // Solicitar endereço do contrato
                    contractAddress = prompt("Cole o endereço do contrato deployado:");
                    if (!contractAddress || !web3.utils.isAddress(contractAddress)) {
                        alert("Endereço do contrato inválido!");
                        return;
                    }
                    
                    // Inicializar contrato
                    contract = new web3.eth.Contract(CONTRACT_ABI, contractAddress);
                    
                    // Habilitar painel de arbitragem
                    document.getElementById('arbitragePanel').style.display = 'block';
                    
                } catch (error) {
                    console.error("Erro ao conectar carteira:", error);
                    alert("Erro ao conectar: " + error.message);
                }
            } else {
                alert('Por favor, instale MetaMask!');
            }
        });
        
        // Configurar evento de mudança de rede
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => window.location.reload());
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    window.location.reload();
                } else {
                    account = accounts[0];
                    document.getElementById('walletAddress').textContent = `Conectado: ${account.substring(0, 6)}...${account.substring(38)}`;
                }
            });
        }
        
        // Buscar tokens (simulação)
        document.getElementById('searchTokens').addEventListener('click', async () => {
            if (!web3) {
                alert('Conecte sua carteira primeiro!');
                return;
            }
            
            // Mostrar loading
            const searchBtn = document.getElementById('searchTokens');
            searchBtn.disabled = true;
            searchBtn.textContent = "Buscando...";
            
            // Simulação de busca (em produção, você chamaria um backend)
            setTimeout(() => {
                const mockData = [
                    { 
                        token: 'WETH', 
                        address: WMATIC,
                        prices: {
                            uniswap: (1.02 + Math.random() * 0.02).toFixed(4),
                            sushiswap: (1.01 + Math.random() * 0.02).toFixed(4),
                            quickswap: (1.03 + Math.random() * 0.02).toFixed(4)
                        }
                    },
                    { 
                        token: 'USDC', 
                        address: "0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174",
                        prices: {
                            uniswap: (1.001 + Math.random() * 0.001).toFixed(4),
                            sushiswap: (0.999 + Math.random() * 0.001).toFixed(4),
                            quickswap: (1.002 + Math.random() * 0.001).toFixed(4)
                        }
                    }
                ];
                
                updatePriceTable(mockData);
                
                searchBtn.disabled = false;
                searchBtn.textContent = "Buscar em todas as DEXs";
            }, 1500);
        });
        
        function updatePriceTable(tokenData) {
            const tableBody = document.getElementById('pricesTableBody');
            tableBody.innerHTML = '';
            
            tokenData.forEach(token => {
                const prices = token.prices;
                const minPrice = Math.min(...Object.values(prices));
                const maxPrice = Math.max(...Object.values(prices));
                const difference = ((maxPrice - minPrice) / minPrice * 100).toFixed(2);
                
                const row = document.createElement('tr');
                if (difference > 1) row.classList.add('arbitrage-opportunity');
                
                row.innerHTML = `
                    <td>${token.token} (${token.address.substring(0, 6)}...)</td>
                    <td>${prices.uniswap}</td>
                    <td>${prices.sushiswap}</td>
                    <td>${prices.quickswap}</td>
                    <td>${difference}%</td>
                    <td><button class="setupArbitrage" data-token="${token.token}" data-address="${token.address}">Configurar</button></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Adicionar listeners aos botões de configuração
            document.querySelectorAll('.setupArbitrage').forEach(button => {
                button.addEventListener('click', (e) => {
                    const token = e.target.getAttribute('data-token');
                    const address = e.target.getAttribute('data-address');
                    setupArbitrage(token, address);
                });
            });
        }
        
        function setupArbitrage(token, tokenAddress) {
            document.getElementById('tokenAddress').value = tokenAddress;
            
            // Atualizar estimativa de lucro quando a quantidade mudar
            document.getElementById('tokenAmount').addEventListener('input', updateProfitEstimate);
            
            // Habilitar botão de execução
            document.getElementById('executeArbitrage').disabled = false;
            
            // Atualizar estimativa inicial
            updateProfitEstimate();
        }
        
        async function updateProfitEstimate() {
            const buyDex = document.getElementById('buyDex').value;
            const sellDex = document.getElementById('sellDex').value;
            const tokenAddress = document.getElementById('tokenAddress').value;
            const amount = document.getElementById('tokenAmount').value;
            
            if (!tokenAddress || !amount || amount <= 0) return;
            
            try {
                // Simulação de cálculo de lucro (em produção, você chamaria o contrato)
                const buyPrice = parseFloat(await simulateGetPrice(buyDex, WMATIC, tokenAddress, amount));
                const sellPrice = parseFloat(await simulateGetPrice(sellDex, tokenAddress, WMATIC, buyPrice));
                
                const profit = sellPrice - amount;
                const fee = profit * 0.005; // 0.5%
                const netProfit = profit - fee;
                
                document.getElementById('expectedProfit').textContent = netProfit.toFixed(6);
                
            } catch (error) {
                console.error("Erro ao estimar lucro:", error);
                document.getElementById('expectedProfit').textContent = "Erro";
            }
        }
        
        // Simular obtenção de preço
        async function simulateGetPrice(dex, tokenIn, tokenOut, amountIn) {
            // Em produção, substituir por chamada real ao contrato
            return new Promise(resolve => {
                setTimeout(() => {
                    const basePrices = {
                        "WETH": 1.0,
                        "USDC": 1.0
                    };
                    
                    const tokenInSym = tokenIn === WMATIC ? "WETH" : "USDC";
                    const tokenOutSym = tokenOut === WMATIC ? "WETH" : "USDC";
                    
                    const price = (basePrices[tokenOutSym] / basePrices[tokenInSym]) * (0.98 + Math.random() * 0.04);
                    resolve((amountIn * price).toFixed(6));
                }, 500);
            });
        }
        
        // Executar arbitragem
        document.getElementById('executeArbitrage').addEventListener('click', async () => {
            const buyDex = document.getElementById('buyDex').value;
            const sellDex = document.getElementById('sellDex').value;
            const tokenAddress = document.getElementById('tokenAddress').value;
            const amount = document.getElementById('tokenAmount').value;
            const expectedProfit = document.getElementById('expectedProfit').textContent;
            
            if (!buyDex || !sellDex || !tokenAddress || !amount || amount <= 0) {
                alert('Preencha todos os campos!');
                return;
            }
            
            if (buyDex === sellDex) {
                alert('Selecione DEXs diferentes!');
                return;
            }
            
            if (!web3.utils.isAddress(tokenAddress)) {
                alert('Endereço do token inválido!');
                return;
            }
            
            const executeBtn = document.getElementById('executeArbitrage');
            const statusDiv = document.getElementById('transactionStatus');
            
            executeBtn.disabled = true;
            statusDiv.textContent = "Enviando transação...";
            statusDiv.style.color = "blue";
            
            try {
                const amountWei = web3.utils.toWei(amount, 'ether');
                const expectedProfitWei = web3.utils.toWei(expectedProfit, 'ether');
                
                const tx = await contract.methods.executeArbitrage(
                    buyDex,
                    sellDex,
                    tokenAddress,
                    amountWei,
                    expectedProfitWei
                ).send({
                    from: account,
                    value: amountWei
                });
                
                statusDiv.textContent = `Sucesso! TX: ${tx.transactionHash}`;
                statusDiv.style.color = "green";
                
            } catch (error) {
                console.error("Erro na arbitragem:", error);
                statusDiv.textContent = `Erro: ${error.message}`;
                statusDiv.style.color = "red";
            } finally {
                executeBtn.disabled = false;
            }
        });
        
        // Inicializar Web3 (fallback para quando não há MetaMask)
        if (!window.ethereum) {
            document.getElementById('connectWallet').textContent = "Instalar MetaMask";
            document.getElementById('connectWallet').onclick = () => {
                window.open('https://metamask.io/', '_blank');
            };
        }
    </script>
</body>
</html>
