<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- ... (cabeçalho mantido igual) ... -->
</head>
<body>
    <!-- ... (HTML mantido igual) ... -->

    <script>
        // Configurações atualizadas
        const POL_TOKEN = {
            address: "0x455e53CBB86018Ac2B8092FdCd39d8444aFFC3F6",
            abi: [
                {
                    "constant": true,
                    "inputs": [{"name":"owner","type":"address"}],
                    "name": "balanceOf",
                    "outputs": [{"name":"","type":"uint256"}],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {"name":"spender","type":"address"},
                        {"name":"amount","type":"uint256"}
                    ],
                    "name": "approve",
                    "outputs": [{"name":"","type":"bool"}],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ]
        };

        // Variáveis globais atualizadas
        let web3;
        let accounts = [];
        let polTokenContract;
        let isInitialized = false;

        // Novo método de inicialização
        async function initializeContracts() {
            try {
                if (!web3 || !accounts[0]) return;
                
                // Nova instanciação do contrato com tratamento de erro
                polTokenContract = new web3.eth.Contract(
                    POL_TOKEN.abi,
                    POL_TOKEN.address,
                    { from: accounts[0] }
                );
                
                // Verificação de conexão
                const networkId = await web3.eth.net.getId();
                if (networkId !== 137) {
                    throw new Error("Conecte-se à Polygon Mainnet");
                }
                
                isInitialized = true;
                return true;
            } catch (error) {
                console.error("Erro na inicialização:", error);
                showError(statusMessage, `Erro inicial: ${error.message}`);
                return false;
            }
        }

        // Método de atualização de saldo revisado
        async function updatePolBalance() {
            if (!isInitialized || !accounts[0]) {
                polBalanceDisplay.textContent = "-";
                return;
            }

            try {
                // Chamada direta com tratamento de timeout
                const balance = await Promise.race([
                    polTokenContract.methods.balanceOf(accounts[0]).call(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Timeout")), 5000)
                ]);
                
                polBalance = balance;
                const balanceFormatted = web3.utils.fromWei(balance, 'ether');
                polBalanceDisplay.textContent = `${parseFloat(balanceFormatted).toFixed(4)} POL`;
                balanceInfo.textContent = `Saldo: ${parseFloat(balanceFormatted).toFixed(4)} POL`;
                clearStatus(statusMessage);
                
            } catch (error) {
                console.error("Falha ao obter saldo:", {
                    error,
                    contract: polTokenContract,
                    account: accounts[0]
                });
                
                polBalanceDisplay.textContent = "Erro";
                showError(statusMessage, `Falha ao carregar saldo: ${error.message}`);
                
                // Tentativa de reinicialização
                if (error.message.includes("invalid address") || error.message.includes("timeout")) {
                    isInitialized = false;
                    await initializeContracts();
                    if (isInitialized) await updatePolBalance();
                }
            }
        }

        // ... (restante do código mantido com pequenos ajustes) ...
    </script>
</body>
</html>
