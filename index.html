<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>POL ‚Üí USDC - Swap Manual</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.9.0/dist/web3.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f5;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      color: #6c5ce7;
      text-align: center;
    }
    button, input {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
      width: 100%;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
  </style>
</head>
<body>
  <h1>Swap Manual POL ‚Üí USDC</h1>

  <div class="section">
    <button id="connectWallet">Conectar Carteira</button>
    <p id="account">Carteira: n√£o conectada</p>
    <p id="network">Rede: -</p>
  </div>

  <div class="section">
    <p>Saldo de POL: <span id="polBalance">-</span></p>
    <p>Status Pre√ßo Fixo: <span id="overrideStatus">-</span></p>
    <input id="amountPOL" type="number" placeholder="Quantidade de POL" step="0.0001" />
    <button id="approve">1Ô∏è‚É£ Aprovar POL</button>
    <button id="swap">2Ô∏è‚É£ Executar Swap</button>
    <button id="toggle">üîÅ Alternar Pre√ßo Fixo</button>
    <div id="status" class="status"></div>
  </div>

  <script>
    const CONTRACT = "0x6Cc8B4a08be3D8e0C7Ef0F4C9eF1cD336f6DDc4d";
    const POL_TOKEN = "0x455e53CBB86018Ac2B8092FdCd39d8444aFFC3F6";
    const DECIMALS = 18;

    const POL_ABI = [
      { constant: true, name: "balanceOf", inputs: [{ name: "_owner", type: "address" }], outputs: [{ name: "balance", type: "uint256" }], type: "function" },
      { constant: false, name: "approve", inputs: [{ name: "_spender", type: "address" }, { name: "_value", type: "uint256" }], outputs: [{ name: "success", type: "bool" }], type: "function" }
    ];

    const PROXY_ABI = [
      { name: "swapPOLForUSDC", type: "function", stateMutability: "nonpayable", inputs: [{ name: "amountPOL", type: "uint256" }], outputs: [] },
      { name: "togglePriceOverride", type: "function", stateMutability: "nonpayable", inputs: [], outputs: [] },
      { name: "priceOverrideActive", type: "function", stateMutability: "view", inputs: [{ name: "", type: "address" }], outputs: [{ name: "", type: "bool" }] }
    ];

    let web3, account, pol, proxy;

    const statusEl = (msg, cls = 'info') => {
      const el = document.getElementById('status');
      el.className = `status ${cls}`;
      el.innerText = msg;
    };

    const toWei = (amount) => web3.utils.toBN(amount * 10 ** DECIMALS);
    const fromWei = (amount) => (Number(amount) / 10 ** DECIMALS).toFixed(4);

    document.getElementById('connectWallet').onclick = async () => {
      if (!window.ethereum) return alert("MetaMask n√£o encontrado");
      web3 = new Web3(window.ethereum);
      await ethereum.request({ method: 'eth_requestAccounts' });
      const chainId = await web3.eth.getChainId();
      if (chainId !== 137) return statusEl("Conecte √† rede Polygon (ChainID 137)", "error");
      account = (await web3.eth.getAccounts())[0];
      document.getElementById('account').innerText = `Carteira: ${account}`;
      document.getElementById('network').innerText = "Rede: Polygon";
      pol = new web3.eth.Contract(POL_ABI, POL_TOKEN);
      proxy = new web3.eth.Contract(PROXY_ABI, CONTRACT);
      refresh();
    };

    async function refresh() {
      const bal = await pol.methods.balanceOf(account).call();
      document.getElementById('polBalance').innerText = fromWei(bal);
      const override = await proxy.methods.priceOverrideActive(account).call();
      document.getElementById('overrideStatus').innerText = override ? "Ativado" : "Desativado";
    }

    document.getElementById('approve').onclick = async () => {
      const amt = document.getElementById('amountPOL').value;
      if (!amt) return statusEl("Digite uma quantidade", "error");
      const val = toWei(amt);
      statusEl("Aprovando tokens...");
      await pol.methods.approve(CONTRACT, val).send({ from: account });
      statusEl("Tokens aprovados", "success");
    };

    document.getElementById('swap').onclick = async () => {
      const amt = document.getElementById('amountPOL').value;
      if (!amt) return statusEl("Digite uma quantidade", "error");
      const val = toWei(amt);

      try {
        // Verificar status do pre√ßo fixo
        const overrideActive = await proxy.methods.priceOverrideActive(account).call();
        if (!overrideActive) {
          statusEl("Ativando pre√ßo fixo primeiro...");
          await proxy.methods.togglePriceOverride().send({ from: account });
          await new Promise(resolve => setTimeout(resolve, 1500));
        }

        // Revalidar
        const recheck = await proxy.methods.priceOverrideActive(account).call();
        if (!recheck) throw new Error("Pre√ßo fixo n√£o foi ativado. Cancele e tente novamente.");

        // Executar swap
        statusEl("Executando swap...");
        await proxy.methods.swapPOLForUSDC(val).send({ from: account });
        statusEl("Swap executado com sucesso", "success");
        refresh();

      } catch (err) {
        statusEl("Erro no swap: " + (err.message || err), "error");
        console.error(err);
      }
    };

    document.getElementById('toggle').onclick = async () => {
      try {
        statusEl("Alternando status...");
        await proxy.methods.togglePriceOverride().send({ from: account });
        statusEl("Status de pre√ßo fixo alterado", "success");
        refresh();
      } catch (err) {
        statusEl("Erro ao alternar: " + err.message, "error");
      }
    };
  </script>
</body>
</html>
